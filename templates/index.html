<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />
    <title>Âπ¥Â∫¶ÂΩ±ÁâáÂ§ßÊØîÊãö</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Microsoft JhengHei", "ÂæÆËªüÊ≠£ÈªëÈ´î", sans-serif;
      }

      body {
        background-color: #000;
        color: #fff;
      }

      .upload-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        align-items: flex-end;
        z-index: 1000;
      }

      #fileInput {
        display: none;
      }

      .upload-btn {
        background-color: rgba(0, 149, 246, 0.9);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 24px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .upload-btn:hover {
        background-color: rgba(0, 149, 246, 1);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .upload-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .upload-btn::before {
        content: "üì§";
        font-size: 20px;
      }

      .video-container {
        position: relative;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
      }

      .video-item {
        height: 100%;
        width: 100%;
        display: none;
        position: relative;
        z-index: 1000;
      }

      .video-item.active {
        display: block;
      }

      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        pointer-events: none;
      }

      .video-controls {
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1002;
        pointer-events: none;
      }

      .navigation-controls {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        transform: translateY(-50%);
        display: flex;
        justify-content: space-between;
        padding: 0 20px;
        z-index: 1005;
      }

      .nav-btn {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .nav-btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .video-info {
        position: absolute;
        top: 20px;
        left: 20px;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        color: white;
      }

      .vote-btn {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background-color: #ff4757;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 24px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        pointer-events: auto;
      }

      .vote-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .vote-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .vote-btn::before {
        content: "üëç";
        font-size: 16px;
      }

      .vote-btn.voted::before {
        content: "‚úì";
      }

      .vote-btn.voted {
        background-color: #2ed573;
      }

      .vote-btn {
        margin-left: 0;
      }

      .video-controls {
        display: true;
      }

      .progress-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        gap: 2px;
        padding: 0;
        z-index: 1000;
        background-color: rgba(0, 0, 0, 0.2);
      }

      .progress-item {
        flex: 1;
        height: 4px;
        background-color: rgba(255, 255, 255, 0.3);
        position: relative;
        margin: 0 2px;
      }

      /* Âú®ÊâãÊ©üÁâàÁâπÂà•Ë™øÊï¥ */
      @media (max-width: 768px) {
        .progress-item {
          height: 6px;
          margin: 0 3px;
        }
      }

      .progress-item .progress-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        width: 0%;
      }

      .progress-item.viewed .progress-bar {
        width: 100%;
      }

      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 10px;
        display: none;
        text-align: center;
        z-index: 1500;
        min-width: 200px;
        color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .loading-progress {
        margin-top: 10px;
        font-size: 14px;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 10px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .upload-form-container {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.9);
        padding: 20px;
        border-radius: 10px;
        z-index: 2000;
        width: 90%;
        max-width: 400px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: white;
      }

      .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #444;
        border-radius: 4px;
        background-color: #333;
        color: white;
      }

      .form-text {
        color: #888;
        font-size: 12px;
        margin-top: 4px;
      }

      .btn-primary {
        background-color: #0095f6;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .btn-primary:hover {
        background-color: #0081d6;
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
      }

      .video-title {
        position: absolute;
        top: 60px;
        left: 20px;
        right: 20px;
        text-align: center;
        background-color: transparent;
        color: rgba(255, 255, 255, 0.8);
        padding: 10px;
        font-size: 14px;
        z-index: 10;
        font-family: "Microsoft JhengHei", sans-serif;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      }

      .side-nav {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 25%;
        cursor: pointer;
        z-index: 1005;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: auto;
      }

      .side-nav:hover {
        opacity: 0.1;
        background-color: rgba(255, 255, 255, 0.2);
      }

      .side-nav.prev {
        left: 0;
      }

      .side-nav.next {
        right: 0;
      }

      .play-hint {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.7);
        padding: 20px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        z-index: 1010;
      }

      .play-icon {
        font-size: 40px;
        color: white;
      }

      .play-text {
        color: white;
        font-size: 16px;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 3000;
      }

      .loading-overlay .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      .loading-overlay .loading-text {
        color: white;
        font-size: 18px;
        font-family: "Microsoft JhengHei", sans-serif;
      }

      .processing-hint {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 1010;
      }

      .processing-hint .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .processing-hint .hint-text {
        color: white;
        font-size: 14px;
      }

      .rankings-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        transition: all 0.3s ease;
      }

      .rankings-container.collapsed .rankings-content {
        display: none;
      }

      .rankings-toggle {
        width: 40px;
        height: 40px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease;
      }

      .rankings-toggle:hover {
        transform: scale(1.1);
      }

      .rankings-content {
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 10px;
        margin-top: 10px;
        min-width: 300px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .rankings-header {
        text-align: center;
        margin-bottom: 15px;
        width: 100%;
      }

      .rankings-header h3 {
        color: #fff;
        font-size: 16px;
        margin: 0;
        display: inline-block;
      }

      .rankings-list {
        width: 100%;
      }

      .ranking-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 5px;
        transition: background-color 0.2s;
      }

      .ranking-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .ranking-thumbnail {
        width: 60px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
        background-color: rgba(255, 255, 255, 0.1);
      }

      .ranking-position {
        font-weight: bold;
        color: #ffd700;
        width: 20px;
      }

      .ranking-title {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #fff;
      }

      .ranking-votes {
        color: #69ff47;
        font-weight: bold;
      }

      .intro-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.5s ease;
      }

      .intro-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .intro-container.hidden {
        display: none;
      }

      .welcome-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
      }

      .welcome-content {
        background: white;
        text-align: center;
        padding: 40px;
        max-width: 600px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .welcome-content h2 {
        color: #000a96;
        margin-bottom: 20px;
        font-size: 24px;
      }

      .welcome-content p {
        color: #474747;
        line-height: 1.6;
        margin-bottom: 30px;
      }

      .start-btn {
        background-color: #000a96;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 24px;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .welcome-container.hidden {
        display: none;
      }

      /* Á¢∫‰øùÁâπÂÆöÂÖÉÁ¥†‰πü‰ΩøÁî®Áõ∏ÂêåÂ≠óÈ´î */
      .welcome-content h2,
      .welcome-content p,
      .video-info,
      .vote-btn,
      .upload-btn,
      .loading-text,
      .play-text,
      .form-group label,
      .form-control,
      .form-text,
      .video-title,
      .ranking-title,
      .rankings-header h3 {
        font-family: "Microsoft JhengHei", "ÂæÆËªüÊ≠£ÈªëÈ´î", sans-serif;
      }

      /* ÁßªÈô§ÂÖ∂‰ªñÂú∞ÊñπÁöÑÂ≠óÈ´îË®≠ÂÆö */
      .video-title {
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      }

      /* Èò≤Ê≠¢ iOS Á∏ÆÊîæ */
      input[type="text"],
      input[type="number"],
      textarea {
        font-size: 16px; /* Èò≤Ê≠¢ iOS Ëá™ÂãïÁ∏ÆÊîæÁöÑÊúÄÂ∞èÂ≠óÂ§ßÂ∞è */
        max-height: 100%;
        -webkit-text-size-adjust: 100%;
      }

      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 10px;
        display: none;
        text-align: center;
        z-index: 1500;
        min-width: 200px;
        color: white;
      }

      .upload-progress {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.9);
        padding: 30px;
        border-radius: 15px;
        display: none;
        text-align: center;
        z-index: 2000;
        min-width: 300px;
        color: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .upload-text {
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <div id="welcomeContainer" class="welcome-container">
      <div class="welcome-content">
        <h2>2024Âπ¥Â∫¶‰ª£Ë°®ÂΩ±ÁâáÂ§ßË≥Ω</h2>
        <p>
          Âú®ÈÄôË£°ÊúâÂ§ßÂÆ∂Á≤æÂøÉÊåëÈÅ∏ÁöÑ‰ªäÂπ¥Áï∂‰∏≠ÊúÄÁ∂ìÂÖ∏ÁöÑ‰ª£Ë°®ÂΩ±ÁâáÔºåË¨ùË¨ù‰Ω†ÈÄôÈÄôÈ∫ºÂñúÊÑõÊàëÂÄëÁöÑÂØ∂Ë≤ùÔºåË´ãÊ†πÊìö‰Ω†ÁöÑÊúÄÊÑõÊäïÂá∫ÊúÄÂÖ∑‰ª£Ë°®ÊÄßÁöÑ‰∏ÄÁ•®Âêß„ÄÇ
        </p>
        <button id="startButton" class="start-btn">ÈñãÂßãÊäïÁ•®</button>
      </div>
    </div>

    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">ÂΩ±ÁâáËºâÂÖ•‰∏≠ÔºåË´ãÁ®çÂÄô...</div>
    </div>

    <div id="uploadProgress" class="upload-progress">
      <div class="loading-spinner"></div>
      <div id="uploadProgressText" class="upload-text"></div>
    </div>

    <div id="introContainer" class="intro-container">
      <video id="introVideo" src="/static/intro.mp4" playsinline></video>
    </div>

    <div class="video-container" id="videoContainer">
      <!-- ÂΩ±ÁâáÂ∞áÂú®ÈÄôË£°ÂãïÊÖãÂä†Ëºâ -->
    </div>

    <div class="progress-container" id="progressContainer">
      <!-- ÈÄ≤Â∫¶Ê¢ùÂ∞áÂú®ÈÄôË£°ÂãïÊÖãÁîüÊàê -->
    </div>

    <div class="navigation-controls">
      <button class="nav-btn" onclick="previousVideo()">‚óÄ</button>
      <button class="nav-btn" onclick="nextVideo()">‚ñ∂</button>
    </div>

    <div class="upload-container">
      <button class="upload-btn" onclick="showUploadForm()">‰∏äÂÇ≥ÂΩ±Áâá</button>
    </div>

    <div class="upload-form-container" id="uploadFormContainer">
      <button class="close-btn" onclick="closeUploadForm()">√ó</button>
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="custom_filename">Ê™îÊ°àÂêçÁ®±Ôºö</label>
          <input
            type="text"
            id="custom_filename"
            name="custom_filename"
            class="form-control"
            required
          />
          <small class="form-text text-muted"
            >Ë´ãËº∏ÂÖ•ÊÉ≥Ë¶ÅÁöÑÊ™îÊ°àÂêçÁ®±Ôºà‰∏çÈúÄË¶ÅÂåÖÂê´ÂâØÊ™îÂêçÔºâ</small
          >
        </div>
        <div class="form-group">
          <label for="video">ÈÅ∏ÊìáÂΩ±ÁâáÔºö</label>
          <input
            type="file"
            id="video"
            name="video"
            accept=".mp4,.mov,.avi"
            class="form-control"
            required
          />
          <small class="form-text text-muted"
            >ÊîØÊè¥ÁöÑÊ†ºÂºèÔºöMP4, MOV, AVIÔºàÊúÄÂ§ß 100MBÔºâ</small
          >
        </div>
        <button type="submit" class="btn-primary">‰∏äÂÇ≥</button>
      </form>
    </div>

    <div class="rankings-container collapsed">
      <div class="rankings-toggle">
        <span>üèÜ</span>
      </div>
      <div class="rankings-content">
        <div class="rankings-header">
          <h3>‰∫∫Ê∞£ÊéíË°åÊ¶ú</h3>
        </div>
        <div class="rankings-list"></div>
      </div>
    </div>

    <div id="preloadContainer" style="display: none"></div>

    <script>
      let currentVideoIndex = 0;
      let videos = [];
      let isPlaying = true;
      let isMuted = true;
      let isUploading = false;

      function showLoading() {
        document.getElementById("loading").style.display = "block";
      }

      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }

      function showUploadProgress(message) {
        const uploadProgress = document.getElementById("uploadProgress");
        const uploadProgressText =
          document.getElementById("uploadProgressText");
        uploadProgress.style.display = "block";
        uploadProgressText.innerHTML = message;
      }

      function hideUploadProgress() {
        document.getElementById("uploadProgress").style.display = "none";
      }

      // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Á¨¨‰∏ÄÊ¨°Ë®™Âïè
      function checkFirstVisit() {
        if (!localStorage.getItem("hasVisited")) {
          document.getElementById("welcomeContainer").style.display = "block";
          localStorage.setItem("hasVisited", "true");
        }
      }

      function closeWelcomeModal() {
        document.getElementById("welcomeContainer").style.display = "none";
      }

      // Ê∑ªÂä†È†êÂä†ËºâÂáΩÊï∏
      async function preloadVideos() {
        try {
          const response = await fetch("/videos");
          const data = await response.json();
          videos = data;

          if (videos.length > 0) {
            const preloadContainer =
              document.getElementById("preloadContainer");
            const preloadPromises = videos.map((video) => {
              return new Promise((resolve, reject) => {
                const videoElement = document.createElement("video");
                videoElement.src = `/uploads/${video.filename}`;
                videoElement.preload = "auto";

                videoElement.addEventListener("canplaythrough", () => {
                  resolve();
                });

                videoElement.addEventListener("error", () => {
                  reject(new Error(`Failed to load video: ${video.filename}`));
                });

                preloadContainer.appendChild(videoElement);
              });
            });

            // Á≠âÂæÖÊâÄÊúâÂΩ±ÁâáÂä†ËºâÂÆåÊàê
            await Promise.all(preloadPromises);
          }
        } catch (error) {
          console.error("È†êÂä†ËºâÂΩ±ÁâáÂ§±Êïó:", error);
        }
      }

      // ‰øÆÊîπÂàùÂßãÂåñÈÉ®ÂàÜ
      window.onload = function () {
        checkFirstVisit();
        const introVideo = document.getElementById("introVideo");
        const introContainer = document.getElementById("introContainer");
        const welcomeContainer = document.getElementById("welcomeContainer");

        // ÁßªÈô§Ëá™ÂãïÊí≠ÊîæÂ±¨ÊÄßÔºåÁ≠âÂæÖÈªûÊìäÈñãÂßãÊåâÈàï
        introVideo.autoplay = false;
        introVideo.muted = true;

        // ÈªûÊìäÈñãÂßãÊåâÈàïÁöÑËôïÁêÜ
        document.getElementById("startButton").addEventListener("click", () => {
          welcomeContainer.classList.add("hidden");
          introVideo.muted = false;
          introVideo.play();

          // ÈñãÂßãÈ†êÂä†ËºâÂΩ±Áâá
          preloadVideos();

          introVideo.onended = () => {
            introContainer.style.opacity = 0;
            setTimeout(() => {
              introContainer.classList.add("hidden");
              // Êé•È°ØÁ§∫ÂΩ±ÁâáÔºå‰∏çÈúÄË¶ÅÈáçÊñ∞Âä†Ëºâ
              if (videos.length > 0) {
                createProgressBars();
                showVideo(currentVideoIndex);
              }
            }, 500);
          };
        });
      };

      // ‰øÆÊîπ loadVideos ÂáΩÊï∏
      async function loadVideos() {
        try {
          const response = await fetch("/videos");
          videos = await response.json();

          if (videos.length > 0) {
            createProgressBars();

            // ÂâµÂª∫ÂΩ±ÁâáÂÖÉÁ¥†
            const videoContainer = document.querySelector(".video-container");
            videos.forEach((videoData, index) => {
              const videoItem = document.createElement("div");
              videoItem.className = `video-item ${index === 0 ? "active" : ""}`;
              videoItem.innerHTML = `
                    <video playsinline loop>
                        <source src="/uploads/${videoData.filename}" type="video/mp4">
                    </video>
                    <div class="video-info">
                        <div class="video-title">${videoData.title}</div>
                        <div class="video-stats">
                            <span>üëÅÔ∏è ${videoData.views}</span>
                        </div>
                    </div>
                `;
              videoContainer.appendChild(videoItem);
            });

            // ÂàùÂßãÂåñÁ¨¨‰∏ÄÂÄãÂΩ±Áâá
            currentVideoIndex = 0;
            const firstVideo = document.querySelector(
              ".video-item.active video"
            );

            // ÂàùÂßãÂåñÊäïÁ•®ÊåâÈàï
            updateVoteButton(voteBtn, videos[0].voted, videos[0].votes);

            // ËºâÂÖ•Á¨¨‰∏ÄÂÄãÂΩ±Áâá
            loadVideo(0);
          }
        } catch (error) {
          console.error("ËºâÂÖ•ÂΩ±ÁâáÂ§±Êïó:", error);
        }
      }

      // ‰øÆÊîπÂàáÊèõÂΩ±ÁâáÂáΩÊï∏
      function switchVideo(direction) {
        const currentVideo = document.querySelector(".video-item.active video");
        currentVideo.pause();

        const items = document.querySelectorAll(".video-item");
        items[currentVideoIndex].classList.remove("active");

        currentVideoIndex =
          (currentVideoIndex + direction + videos.length) % videos.length;
        items[currentVideoIndex].classList.add("active");

        // ËºâÂÖ•Êñ∞ÁöÑÂΩ±Áâá
        loadVideo(currentVideoIndex);

        // Êõ¥Êñ∞ÊäïÁ•®ÊåâÈàïÁãÄÊÖã
        updateVoteButton(
          voteBtn,
          videos[currentVideoIndex].voted,
          videos[currentVideoIndex].votes
        );
        updateProgressBar();
      }

      // ‰øÆÊîπÂΩ±ÁâáËºâÂÖ•ÂáΩÊï∏
      function loadVideo(index) {
        const videoElement = document.querySelector(".video-item.active video");
        console.log("ËºâÂÖ•ÂΩ±Áâá:", index);

        // ÈáçÁΩÆËßÄÁúãËøΩËπ§
        viewTracking = {
          startTime: null,
          hasRecorded: false,
          minViewDuration: 5,
        };

        // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        const newVideo = videoElement.cloneNode(true);
        videoElement.parentNode.replaceChild(newVideo, videoElement);

        // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        newVideo.addEventListener("play", () => {
          console.log("ÂΩ±ÁâáÈñãÂßãÊí≠Êîæ");
          viewTracking.startTime = Date.now();
        });

        newVideo.addEventListener("timeupdate", () => {
          if (
            !viewTracking.hasRecorded &&
            viewTracking.startTime &&
            !newVideo.paused
          ) {
            const duration = (Date.now() - viewTracking.startTime) / 1000;
            console.log("Êí≠ÊîæÊôÇÈñì:", duration);

            if (duration >= viewTracking.minViewDuration) {
              console.log("Ë®òÈåÑËßÄÁúã");
              recordView(videos[index].filename);
              viewTracking.hasRecorded = true;
            }
          }
        });

        // Ë®≠ÁΩÆÂΩ±ÁâáÈùúÈü≥ÁãÄÊÖã
        newVideo.muted = true;

        // Ëá™ÂãïÊí≠Êîæ
        newVideo.play().catch((error) => {
          console.error("Ëá™ÂãïÊí≠ÊîæÂ§±Êïó:", error);
        });
      }

      // ‰øÆÊîπËßÄÁúãË®òÈåÑÂáΩÊï∏
      async function recordView(filename) {
        try {
          const fingerprint = generateFingerprint();
          console.log("ÁôºÈÄÅËßÄÁúãË®òÈåÑ:", filename, fingerprint);

          const response = await fetch(`/view/${filename}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Device-Fingerprint": fingerprint,
            },
          });

          const data = await response.json();
          console.log("ËßÄÁúãË®òÈåÑÂõûÊáâ:", data);

          if (response.ok) {
            // Êõ¥Êñ∞È°ØÁ§∫
            videos[currentVideoIndex].views = data.views;
            const statsElement = document.querySelector(
              ".video-item.active .video-stats span"
            );
            if (statsElement) {
              statsElement.textContent = `üëÅÔ∏è ${data.views}`;
            }
          } else {
            throw new Error(data.error || "Ë®òÈåÑÂ§±Êïó");
          }
        } catch (error) {
          console.error("Ë®òÈåÑËßÄÁúãÊ¨°Êï∏Â§±Êïó:", error);
        }
      }

      // ÂâµÂª∫ÊâÄÊúâÈÄ≤Â∫¶Ê¢ù
      function createProgressBars() {
        const container = document.getElementById("progressContainer");
        container.innerHTML = "";

        videos.forEach((_, index) => {
          const progressItem = document.createElement("div");
          progressItem.className = "progress-item";
          if (index < currentVideoIndex) {
            progressItem.className += " viewed";
          }

          const progressBar = document.createElement("div");
          progressBar.className = "progress-bar";

          progressItem.appendChild(progressBar);
          container.appendChild(progressItem);
        });
      }

      // Êõ¥Êñ∞Áï∂ÂâçÈÄ≤Â∫¶Ê¢ù
      function updateProgressBar(video) {
        const progressBars = document.querySelectorAll(".progress-item");
        const currentProgress =
          progressBars[currentVideoIndex].querySelector(".progress-bar");
        const progress = (video.currentTime / video.duration) * 100;
        currentProgress.style.width = `${progress}%`;
      }

      // È°ØÁ§∫ÁâπÂÆöÁ¥¢ÂºïÁöÑÂΩ±Áâá
      function showVideo(index) {
        const videoContainer = document.getElementById("videoContainer");
        const videoItems = document.querySelectorAll(".video-item");
        videoItems.forEach((item) => item.remove());

        const videoItem = document.createElement("div");
        videoItem.className = "video-item active";

        const video = document.createElement("video");
        video.src = `/uploads/${videos[index].filename}`;
        video.preload = "auto";
        video.autoplay = false; // ÂÖà‰∏çËá™ÂãïÊí≠Êîæ
        video.muted = isMuted;
        video.playsInline = true;

        // ‰øÆÊîπÂä†Ëºâ‰∫ã‰ª∂ËôïÁêÜ
        video.addEventListener("loadedmetadata", () => {
          // Âè™ÊúâÂú®Èùû‰∏äÂÇ≥ÁãÄÊÖãÊôÇÊâçÈ°ØÁ§∫Âä†ËºâÂãïÁï´
          if (
            !isUploading &&
            document.querySelector(".intro-container.hidden")
          ) {
            showLoading("video");
          }
        });

        video.addEventListener("canplaythrough", () => {
          // Âè™ÊúâÂú®Èùû‰∏äÂÇ≥ÁãÄÊÖãÊôÇÊâçËôïÁêÜÂä†ËºâÂÆåÊàê
          if (!isUploading) {
            hideLoading("video");
            if (isPlaying) {
              video.play();
            }
          }
        });

        video.addEventListener("error", () => {
          if (!isUploading) {
            hideLoading("video");
            alert("ÂΩ±ÁâáËºâÂÖ•Â§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢");
          }
        });

        // Ê∑ªÂä†Êí≠ÊîæÈñãÂßã‰∫ã‰ª∂ËôïÁêÜ
        video.onplay = async () => {
          try {
            // ÈåÑËßÄÁúãÊ¨°Êï∏
            const response = await fetch(`/view/${videos[index].filename}`, {
              method: "POST",
            });
            const data = await response.json();
            videos[currentVideoIndex].views = data.views;
          } catch (error) {
            console.error("ÈåÑËßÄÁúãÊ¨°Êï∏Êïó:", error);
          }
        };

        // Âú®ÈùúÈü≥ÁãÄÊÖã‰∏ãÈ°ØÁ§∫ÊèêÁ§∫
        const playHint = document.createElement("div");
        playHint.className = "play-hint";
        playHint.innerHTML = `
            <div class="play-icon">üîä</div>
            <div class="play-text">ÈªûÊìäÈñãÂïüËÅ≤Èü≥</div>
        `;
        playHint.style.display = isMuted ? "flex" : "none";
        videoItem.appendChild(playHint);

        // ‰øÆÊîπÈªûÊìä‰∫ã‰ª∂ËôïÁêÜ
        videoItem.onclick = (event) => {
          if (!event.target.classList.contains("side-nav")) {
            if (video.muted) {
              video.muted = false;
              isMuted = false; // Êõ¥Êñ∞ÂÖ®Â±ÄÈü≥ÁãÄÊÖã
              playHint.style.display = "none";
              isPlaying = true;
            } else {
              // Â¶ÇÊûú‰∏çÊòØÈùúÈü≥ÁãÄÊÖãÔºåÂâáÂàáÊèõÊí≠Êîæ/Êö´ÂÅú
              if (video.paused) {
                video.play();
                isPlaying = true;
              } else {
                video.pause();
                isPlaying = false;
              }
            }
          }
        };

        const videoInfo = document.createElement("div");
        videoInfo.className = "video-info";
        videoInfo.textContent = videos[index].title;

        const controls = document.createElement("div");
        controls.className = "video-controls";

        const voteBtn = document.createElement("button");
        voteBtn.className = "vote-btn";
        if (videos[index].voted) {
          voteBtn.classList.add("voted");
        }
        voteBtn.innerHTML = `
                ÊäïÁ•®
                <span class="vote-count">${videos[index].votes}</span>
            `;

        voteBtn.onclick = async () => {
          try {
            const fingerprint = generateFingerprint();
            console.log("ÁîüÊàêÁöÑÊåáÁ¥ã:", fingerprint);

            const response = await fetch(
              `/vote/${videos[currentVideoIndex].filename}`,
              {
                method: "POST",
                headers: {
                  "X-Device-Fingerprint": fingerprint,
                  "Content-Type": "application/json",
                },
              }
            );

            const data = await response.json();
            console.log("ÊäïÁ•®ÂõûÊáâ:", data);

            if (response.ok) {
              // Êõ¥Êñ∞Áï∂ÂâçÂΩ±ÁâáÁöÑÊäïÁ•®Êï∏
              videos[currentVideoIndex].votes = data.votes;
              videos[currentVideoIndex].voted = data.voted;

              // Â¶ÇÊûúÊúâ‰πãÂâçÁöÑÊäïÁ•®ÔºåÊõ¥Êñ∞‰πãÂâçÂΩ±ÁâáÁöÑÁãÄÊÖã
              if (data.previousVote) {
                const previousIndex = videos.findIndex(
                  (v) => v.id === data.previousVote
                );
                if (previousIndex !== -1) {
                  videos[previousIndex].voted = false;
                  videos[previousIndex].votes -= 1;
                }
              }

              // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
              updateVoteButton(voteBtn, data.voted, data.votes);

              // ‰∏çË¶ÅÈáçÊñ∞ËºâÂÖ•ÂΩ±ÁâáÔºåÂè™Êõ¥Êñ∞ÊäïÁ•®ÁãÄÊÖã
              const currentVideo = document.querySelector(
                ".video-item.active video"
              );
              if (currentVideo.paused) {
                currentVideo.play();
              }
            } else {
              console.error("ÊäïÁ•®Â§±Êïó:", data.error);
              throw new Error(data.error || "ÊäïÁ•®Â§±Êïó");
            }
          } catch (error) {
            console.error("ÊäïÁ•®ÈåØË™§:", error);
            alert(error.message || "ÊäïÁ•®Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶");
          }
        };

        controls.appendChild(voteBtn);
        videoItem.appendChild(video);
        videoItem.appendChild(videoInfo);
        videoItem.appendChild(controls);
        videoContainer.appendChild(videoItem);

        // ‰øÆÊîπÂàùÂßãÊí≠ÊîæÁãÄÊÖã
        if (!isPlaying) {
          video.pause();
        } else {
          video.play();
        }

        // ÂΩ±ÁâáÁµêÊùüÊôÇÊí≠Êîæ‰∏ã‰∏ÄÂÄã
        video.onended = () => {
          const progressBars = document.querySelectorAll(".progress-item");
          progressBars[currentVideoIndex].className = "progress-item viewed";
          nextVideo();
        };

        // Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ù
        video.ontimeupdate = () => {
          updateProgressBar(video);
        };

        // Êõ¥Êñ∞ÊâÄÊúâÈÄ≤Â∫¶Ê¢ùÁöÑÁãÄÊÖã
        const progressBars = document.querySelectorAll(".progress-item");
        progressBars.forEach((bar, i) => {
          if (i < index) {
            // Â∞á‰πãÂâçÁöÑÂΩ±ÁâáÈÄ≤Â∫¶Ê¢ùÈÉΩË®≠Â∑≤ÂÆåÊàê
            bar.className = "progress-item viewed";
            const progressBar = bar.querySelector(".progress-bar");
            progressBar.style.width = "100%";
          } else if (i > index) {
            // ÈáçÁΩÆÂæåÈù¢ÁöÑÂΩ±ÁâáÈÄ≤ÈÄ≤Â∫¶
            bar.className = "progress-item";
            const progressBar = bar.querySelector(".progress-bar");
            progressBar.style.width = "0%";
          }
        });
      }

      // ÂàáÊèõÂà∞‰∏ã‰∏ÄÂÄãÂΩ±Áâá
      function nextVideo() {
        if (videos.length <= 1) return;

        // Â∞áÁï∂ÂâçÂΩ±ÁâáÁöÑÈÄ≤Â∫¶Ê¢ùÁÇ∫ÂÆåÊàê
        const progressBars = document.querySelectorAll(".progress-item");
        const currentProgress = progressBars[currentVideoIndex];
        currentProgress.className = "progress-item viewed";
        const progressBar = currentProgress.querySelector(".progress-bar");
        progressBar.style.width = "100%";

        currentVideoIndex = (currentVideoIndex + 1) % videos.length;
        showVideo(currentVideoIndex);
      }

      // ÂàáÊèõÂà∞‰∏ä‰∏ÄÂÄãÂΩ±Áâá
      function previousVideo() {
        if (videos.length <= 1) return;

        // ÈáçÁΩÆÁï∂ÂâçÂΩ±ÁâáÁöÑÈÄ≤Â∫¶Ê¢ù
        const progressBars = document.querySelectorAll(".progress-item");
        const currentProgress = progressBars[currentVideoIndex];
        currentProgress.className = "progress-item";
        const progressBar = currentProgress.querySelector(".progress-bar");
        progressBar.style.width = "0%";

        currentVideoIndex =
          (currentVideoIndex - 1 + videos.length) % videos.length;
        showVideo(currentVideoIndex);
      }

      function showUploadForm() {
        document.getElementById("uploadFormContainer").style.display = "block";
      }

      function closeUploadForm() {
        document.getElementById("uploadFormContainer").style.display = "none";
      }

      // ‰øÆÊîπÊ™¢Êü•Â£ìÁ∏ÆÁãÄÊÖãÁöÑÂáΩÊï∏
      async function checkCompressionStatus(filename) {
        try {
          // Á¢∫‰øùÊ™îÊ°àÂêçÁ®±ÂåÖÂê´ÂâØÊ™îÂêç
          const fullFilename = filename.includes(".")
            ? filename
            : `${filename}.mp4`;
          console.log("Ê™¢Êü•Ê™îÊ°à:", fullFilename);

          const response = await fetch(`/compression_status/${fullFilename}`);
          const data = await response.json();
          console.log("Â£ìÁ∏ÆÁãÄÊÖã:", data.status);
          return data.status;
        } catch (error) {
          console.error("Ê™¢Êü•Â£ìÁ∏ÆÁãÄÊÖãÂ§±Êïó:", error);
          return "error";
        }
      }

      // ‰øÆÊîπ‰∏äÂÇ≥Ë°®ÂñÆËôïÁêÜ
      document.getElementById("uploadForm").onsubmit = async function (e) {
        e.preventDefault();

        const formData = new FormData();
        const videoFile = document.getElementById("video").files[0];
        const customFilename = document
          .getElementById("custom_filename")
          .value.trim();

        if (!videoFile) {
          alert("Ë´ãÈÅ∏ÊìáÂΩ±ÁâáÊ™îÊ°à");
          return;
        }

        if (!customFilename) {
          alert("Ë´ãËº∏ÂÖ•Ê™îÊ°àÂêçÁ®±");
          return;
        }

        // Ê™¢Êü•Ê™îÊ°àÂ§ßÂ∞è
        if (videoFile.size > 100 * 1024 * 1024) {
          alert("Ê™îÊ°àÂ§ßÂ∞è‰∏çËÉΩË∂ÖÈÅé 100MBÔºåË´ã‰øÆÂâ™ÂΩ±ÁâáÈï∑Â∫¶");
          return;
        }

        formData.append("video", videoFile);
        formData.append("custom_filename", customFilename);

        // ÈóúÈñâ‰∏äÂÇ≥Ë°®ÂñÆ
        closeUploadForm();

        // È°ØÁ§∫‰∏äÂÇ≥‰∏≠ÁöÑÊèêÁ§∫
        showUploadProgress(`
            <div style="font-size: 16px; margin: 10px 0;">ÂΩ±Áâá‰∏äÂÇ≥‰∏≠...</div>
            <small style="color: #999">Ë´ãÂãøÈóúÈñâË¶ñÁ™óÔºå‰∏äÂÇ≥ÂÆåÊàêÂæåÊúÉËá™ÂãïËôïÁêÜ</small>
        `);

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (data.success) {
            showUploadProgress(`
                <div style="font-size: 16px; margin: 10px 0;">ÂΩ±ÁâáËôïÁêÜ‰∏≠...</div>
                <small style="color: #999">Ê≠£Âú®Â£ìÁ∏ÆÂΩ±ÁâáÔºåË´ãÁ®çÂÄô</small>
            `);

            // ‰ΩøÁî®ËøîÂõûÁöÑÊ™îÊ°àÂêçÁ®±ÈÄ≤Ë°åÁãÄÊÖãÊ™¢Êü•
            const filename = data.filename;
            console.log("‰∏äÂÇ≥ÊàêÂäüÔºåÊ™îÊ°àÂêçÁ®±:", filename);

            while (true) {
              const status = await checkCompressionStatus(filename);
              console.log("Áï∂ÂâçÁãÄÊÖã:", status);

              if (status === "completed") {
                showUploadProgress(`
                        <div style="color: #2ecc71; font-size: 40px; margin: 10px 0;">‚úì</div>
                        <div style="font-size: 16px;">ËôïÁêÜÂÆåÊàêÔºÅ</div>
                        <small style="color: #999">È†ÅÈù¢Âç≥Â∞áÈáçÊñ∞Êï¥ÁêÜ</small>
                    `);

                setTimeout(() => {
                  hideUploadProgress();
                  location.reload();
                }, 1500);
                break;
              } else if (status === "error") {
                showUploadProgress(`
                        <div style="color: #e74c3c; font-size: 40px; margin: 10px 0;">‚úó</div>
                        <div style="font-size: 16px;">ÂΩ±ÁâáËôïÁêÜÂ§±Êïó</div>
                    `);
                throw new Error("Â£ìÁ∏ÆÂ§±Êïó");
              } else if (status === "compressing") {
                await new Promise((resolve) => setTimeout(resolve, 1000));
              } else {
                console.error("Êú™Áü•ÁöÑÂ£ìÁ∏ÆÁãÄÊÖã:", status);
                throw new Error("Êú™Áü•ÁöÑËôïÁêÜÁãÄÊÖã");
              }
            }
          } else {
            throw new Error(data.error || "‰∏äÂÇ≥Â§±Êïó");
          }
        } catch (error) {
          console.error("Error:", error);
          showUploadProgress(`
              <div style="color: #e74c3c; font-size: 40px; margin: 10px 0;">‚úó</div>
              <div style="font-size: 16px;">${
                error.message || "ËôïÁêÜÈÅéÁ®ãÁôºÁîüÈåØË™§"
              }</div>
          `);
          setTimeout(() => {
            hideUploadProgress();
          }, 1500);
        }
      };
		
async function updateRankings() {
    try {
        const response = await fetch("/rankings");
        const rankings = await response.json();

        const rankingsList = document.querySelector(".rankings-list");
        rankingsList.innerHTML = ""; // Ê∏ÖÁ©∫ËàäÁöÑÊéíË°åÊ¶úÂÖßÂÆπ

        // ÈáçÊñ∞ÁîüÊàêÊéíË°åÊ¶úÈ†ÖÁõÆ
        rankings.forEach((video, index) => {
            const rankingItem = document.createElement("div");
            rankingItem.className = "ranking-item";

            rankingItem.innerHTML = `
                <span class="ranking-position">${index + 1}</span>
                <img class="ranking-thumbnail" src="/thumbnails/${video.filename}.jpg" alt="${video.title}">
                <span class="ranking-title">${video.title}</span>
                <span class="ranking-votes">${video.votes} Á•®</span>
            `;

            rankingsList.appendChild(rankingItem);
        });
    } catch (error) {
        console.error("Êõ¥Êñ∞ÊéíË°åÊ¶úÂ§±Êïó:", error);
    }
}

      // ÊØè 5 ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°ÊéíË°åÊ¶ú
      setInterval(updateRankings, 10000);
      // ÂàùÂßãÂåñÊéíË°åÊ¶ú
      updateRankings();

      // Ê∑ªÂä†ÊéíË°åÊ¶úÂàáÊèõÂäüËÉΩ
      document
        .querySelector(".rankings-toggle")
        .addEventListener("click", () => {
          document
            .querySelector(".rankings-container")
            .classList.toggle("collapsed");
        });

      // ‰øÆÊîπÁîüÊàêÁÄèË¶ΩÂô®ÊåáÁ¥ãÁöÑÂáΩÊï∏
      function generateFingerprint() {
        const components = {
          userAgent: navigator.userAgent,
          language: navigator.language,
          platform: navigator.platform,
          screenResolution: `${screen.width}x${screen.height}`,
          colorDepth: screen.colorDepth,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          touchSupport: "ontouchstart" in window,
          cookiesEnabled: navigator.cookieEnabled,
          // Ê∑ªÂä†Êõ¥Â§öÂèØÈù†ÁöÑÁâπÂæµ
          pixelRatio: window.devicePixelRatio,
          orientation: screen.orientation ? screen.orientation.type : "unknown",
          plugins: Array.from(navigator.plugins)
            .map((p) => p.name)
            .join(","),
          doNotTrack: navigator.doNotTrack,
          webdriver: navigator.webdriver,
          languages: navigator.languages.join(","),
        };

        // ‰ΩøÁî®Á∞°ÂñÆÁöÑÂ≠ó‰∏≤ËôïÁêÜ‰æÜÁîüÊàêÊåáÁ¥ã
        const fingerprintStr = JSON.stringify(components);
        let hash = 0;

        for (let i = 0; i < fingerprintStr.length; i++) {
          const char = fingerprintStr.charCodeAt(i);
          hash = (hash << 5) - hash + char;
          hash = hash & hash; // Convert to 32-bit integer
        }

        // ËΩâÊèõÁÇ∫Ê≠£Êï∏‰∏¶ËΩâÁÇ∫ 16 ÈÄ≤Âà∂
        const positiveHash = Math.abs(hash).toString(16);
        // Ë£úË∂≥ 32 ‰Ωç
        return "0".repeat(32 - positiveHash.length) + positiveHash;
      }

      // Ê∑ªÂä†Êõ¥Êñ∞ÊäïÁ•®ÊåâÈàïÁöÑÂáΩÊï∏
      function updateVoteButton(button, voted, votes) {
        if (voted) {
          button.classList.add("voted");
        } else {
          button.classList.remove("voted");
        }
        button.innerHTML = `ÊäïÁ•® <span class="vote-count">${votes}</span>`;
      }
    </script>
  </body>
</html>
