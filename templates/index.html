<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />
    <title>Âπ¥Â∫¶ÂΩ±ÁâáÂ§ßÊØîÊãö</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Microsoft JhengHei", "ÂæÆËªüÊ≠£ÈªëÈ´î", sans-serif;
      }

      body {
        background-color: #000;
        color: #fff;
      }

      .upload-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        align-items: flex-end;
        z-index: 1000;
      }

      #fileInput {
        display: none;
      }

      .upload-btn {
        background-color: rgba(0, 149, 246, 0.9);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 24px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .upload-btn:hover {
        background-color: rgba(0, 149, 246, 1);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .upload-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .upload-btn::before {
        content: "üì§";
        font-size: 20px;
      }

      .video-container {
        position: relative;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
      }

      .video-item {
        height: 100%;
        width: 100%;
        display: none;
        position: relative;
        z-index: 1000;
      }

      .video-item.active {
        display: block;
      }

      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        pointer-events: none;
      }

      .video-controls {
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1002;
        pointer-events: none;
      }

      .navigation-controls {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        transform: translateY(-50%);
        display: flex;
        justify-content: space-between;
        padding: 0 20px;
        z-index: 1005;
      }

      .nav-btn {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .nav-btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .video-info {
        position: absolute;
        top: 20px;
        left: 20px;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        color: white;
      }

      .vote-btn {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background-color: #ff4757;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 24px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        pointer-events: auto;
      }

      .vote-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .vote-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .vote-btn::before {
        content: "üëç";
        font-size: 16px;
      }

      .vote-btn.voted::before {
        content: "‚úì";
      }

      .vote-btn.voted {
        background-color: #2ed573;
      }

      .vote-btn {
        margin-left: 0;
      }

      .video-controls {
        display: true;
      }

      .progress-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        gap: 2px;
        padding: 0;
        z-index: 1000;
        background-color: rgba(0, 0, 0, 0.2);
      }

      .progress-item {
        flex: 1;
        height: 4px;
        background-color: rgba(255, 255, 255, 0.3);
        position: relative;
        margin: 0 2px;
      }

      /* Âú®ÊâãÊ©üÁâàÁâπÂà•Ë™øÊï¥ */
      @media (max-width: 768px) {
        .progress-item {
          height: 6px;
          margin: 0 3px;
        }
      }

      .progress-item .progress-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        width: 0%;
      }

      .progress-item.viewed .progress-bar {
        width: 100%;
      }

      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 10px;
        display: none;
        text-align: center;
        z-index: 1500;
        min-width: 200px;
        color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .loading-progress {
        margin-top: 10px;
        font-size: 14px;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 10px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .upload-form-container {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.9);
        padding: 20px;
        border-radius: 10px;
        z-index: 2000;
        width: 90%;
        max-width: 400px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: white;
      }

      .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #444;
        border-radius: 4px;
        background-color: #333;
        color: white;
      }

      .form-text {
        color: #888;
        font-size: 12px;
        margin-top: 4px;
      }

      .btn-primary {
        background-color: #0095f6;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .btn-primary:hover {
        background-color: #0081d6;
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
      }

      .video-title {
        position: absolute;
        top: 60px;
        left: 20px;
        right: 20px;
        text-align: center;
        background-color: transparent;
        color: rgba(255, 255, 255, 0.8);
        padding: 10px;
        font-size: 14px;
        z-index: 10;
        font-family: "Microsoft JhengHei", sans-serif;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      }

      .side-nav {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 25%;
        cursor: pointer;
        z-index: 1005;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: auto;
      }

      .side-nav:hover {
        opacity: 0.1;
        background-color: rgba(255, 255, 255, 0.2);
      }

      .side-nav.prev {
        left: 0;
      }

      .side-nav.next {
        right: 0;
      }

      .play-hint {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.7);
        padding: 20px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        z-index: 1010;
      }

      .play-icon {
        font-size: 40px;
        color: white;
      }

      .play-text {
        color: white;
        font-size: 16px;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 3000;
      }

      .loading-overlay .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      .loading-overlay .loading-text {
        color: white;
        font-size: 18px;
        font-family: "Microsoft JhengHei", sans-serif;
      }

      .processing-hint {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 1010;
      }

      .processing-hint .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .processing-hint .hint-text {
        color: white;
        font-size: 14px;
      }

      .rankings-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        transition: all 0.3s ease;
      }

      .rankings-container.collapsed .rankings-content {
        display: none;
      }

      .rankings-toggle {
        width: 40px;
        height: 40px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease;
      }

      .rankings-toggle:hover {
        transform: scale(1.1);
      }

      .rankings-content {
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 10px;
        margin-top: 10px;
        min-width: 300px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .rankings-header {
        text-align: center;
        margin-bottom: 15px;
        width: 100%;
      }

      .rankings-header h3 {
        color: #fff;
        font-size: 16px;
        margin: 0;
        display: inline-block;
      }

      .rankings-list {
        width: 100%;
      }

      .ranking-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 5px;
        transition: background-color 0.2s;
      }

      .ranking-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .ranking-thumbnail {
        width: 60px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
        background-color: rgba(255, 255, 255, 0.1);
      }

      .ranking-position {
        font-weight: bold;
        color: #ffd700;
        width: 20px;
      }

      .ranking-title {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #fff;
      }

      .ranking-votes {
        color: #69ff47;
        font-weight: bold;
      }

      .intro-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.5s ease;
      }

      .intro-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .intro-container.hidden {
        display: none;
      }

      .welcome-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
      }

      .welcome-content {
        background: white;
        text-align: center;
        padding: 40px;
        max-width: 600px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .welcome-content h2 {
        color: #000a96;
        margin-bottom: 20px;
        font-size: 24px;
      }

      .welcome-content p {
        color: #474747;
        line-height: 1.6;
        margin-bottom: 30px;
      }

      .start-btn {
        background-color: #000a96;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 24px;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .welcome-container.hidden {
        display: none;
      }

      /* Á¢∫‰øùÁâπÂÆöÂÖÉÁ¥†‰πü‰ΩøÁî®Áõ∏ÂêåÂ≠óÈ´î */
      .welcome-content h2,
      .welcome-content p,
      .video-info,
      .vote-btn,
      .upload-btn,
      .loading-text,
      .play-text,
      .form-group label,
      .form-control,
      .form-text,
      .video-title,
      .ranking-title,
      .rankings-header h3 {
        font-family: "Microsoft JhengHei", "ÂæÆËªüÊ≠£ÈªëÈ´î", sans-serif;
      }

      /* ÁßªÈô§ÂÖ∂‰ªñÂú∞ÊñπÁöÑÂ≠óÈ´îË®≠ÂÆö */
      .video-title {
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      }

      /* Èò≤Ê≠¢ iOS Á∏ÆÊîæ */
      input[type="text"],
      input[type="number"],
      textarea {
        font-size: 16px; /* Èò≤Ê≠¢ iOS Ëá™ÂãïÁ∏ÆÊîæÁöÑÊúÄÂ∞èÂ≠óÂ§ßÂ∞è */
        max-height: 100%;
        -webkit-text-size-adjust: 100%;
      }

      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 10px;
        display: none;
        text-align: center;
        z-index: 1500;
        min-width: 200px;
        color: white;
      }

      .upload-progress {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.9);
        padding: 30px;
        border-radius: 15px;
        display: none;
        text-align: center;
        z-index: 2000;
        min-width: 300px;
        color: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .upload-text {
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <!-- ... (all existing HTML remains unchanged) ... -->

    <script>
      let currentVideoIndex = 0;
      let videos = [];
      let isPlaying = true;
      let isMuted = true;
      let isUploading = false;
      let isNavigating = false;
      let debounceTimer;

      function debounce(func, wait) {
        return function() {
          const context = this;
          const args = arguments;
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            func.apply(context, args);
          }, wait);
        };
      }

      function navigateVideo(direction) {
        if (isNavigating) return; // Â¶ÇÊûúÊ≠£Âú®ÂàáÊèõ‰∏≠ÔºåÂâáÂøΩÁï•Êñ∞ÁöÑË´ãÊ±Ç
        
        isNavigating = true;
        const videos = document.querySelectorAll('.video-item');
        let currentIndex = Array.from(videos).findIndex(video => video.classList.contains('active'));
        let nextIndex;
        
        if (direction === 'next') {
          nextIndex = (currentIndex + 1) % videos.length;
        } else {
          nextIndex = (currentIndex - 1 + videos.length) % videos.length;
        }
        
        // Èö±ËóèÁï∂ÂâçÂΩ±Áâá
        videos[currentIndex].classList.remove('active');
        
        // È°ØÁ§∫‰∏ã‰∏ÄÂÄãÂΩ±Áâá
        videos[nextIndex].classList.add('active');
        
        // ÈáçÁΩÆÂΩ±ÁâáÊí≠Êîæ
        const currentVideo = videos[currentIndex].querySelector('video');
        const nextVideo = videos[nextIndex].querySelector('video');
        
        if (currentVideo) {
          currentVideo.pause();
          currentVideo.currentTime = 0;
        }
        
        if (nextVideo) {
          nextVideo.play().catch(error => {
            console.error('Video playback error:', error);
          });
        }
        
        // Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ù
        updateProgressBar(nextIndex);
        
        // 300ms ÂæåÈáçÁΩÆÂ∞éËà™ÁãÄÊÖã
        setTimeout(() => {
          isNavigating = false;
        }, 300);
      }

      // ‰ΩøÁî®Èò≤ÊäñÂåÖË£ùÂ∞éËà™ÂáΩÊï∏
      const debouncedNavigate = debounce(navigateVideo, 200);

      // Êõ¥Êñ∞‰∫ã‰ª∂Áõ£ËÅΩÂô®
      document.querySelector('.prev-btn').addEventListener('click', () => debouncedNavigate('prev'));
      document.querySelector('.next-btn').addEventListener('click', () => debouncedNavigate('next'));

      // Ê∑ªÂä†ÈçµÁõ§‰∫ã‰ª∂Áõ£ËÅΩ
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
          debouncedNavigate('prev');
        } else if (e.key === 'ArrowRight') {
          debouncedNavigate('next');
        }
      });

      function loadVideo(index) {
        const videoElement = document.querySelector(".video-item.active video");
        console.log("ËºâÂÖ•ÂΩ±Áâá:", index);

        // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        const newVideo = videoElement.cloneNode(true);
        videoElement.parentNode.replaceChild(newVideo, videoElement);

        // Âè™Âú®Êí≠ÊîæÈñãÂßãÊôÇË®òÈåÑËßÄÁúãÊ¨°Êï∏
        newVideo.addEventListener("play", async () => {
          console.log("ÂΩ±ÁâáÈñãÂßãÊí≠ÊîæÔºåË®òÈåÑËßÄÁúã");
          try {
            const fingerprint = generateFingerprint(); // ‰øùÁïôÊåáÁ¥ãÁîüÊàê
            const response = await fetch(`/view/${videos[index].filename}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Device-Fingerprint": fingerprint, // ‰ªçÁÑ∂ÁôºÈÄÅÊåáÁ¥ã
              },
            });

            const data = await response.json();
            if (response.ok) {
              // Êõ¥Êñ∞È°ØÁ§∫
              videos[currentVideoIndex].views = data.views;
              const statsElement = document.querySelector(
                ".video-item.active .video-stats span"
              );
              if (statsElement) {
                statsElement.textContent = `üëÅÔ∏è ${data.views}`;
              }
            }
          } catch (error) {
            console.error("Ë®òÈåÑËßÄÁúãÊ¨°Êï∏Â§±Êïó:", error);
          }
        });

        // Ë®≠ÁΩÆÂΩ±ÁâáÈùúÈü≥ÁãÄÊÖã
        newVideo.muted = true;

        // Ëá™ÂãïÊí≠Êîæ
        newVideo.play().catch((error) => {
          console.error("Ëá™ÂãïÊí≠ÊîæÂ§±Êïó:", error);
        });
      }

      // ... (all remaining existing functions remain unchanged) ...
    </script>
  </body>
</html>
