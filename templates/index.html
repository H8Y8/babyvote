<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>影片分享平台</title>
    <style>
      .video-container {
        margin: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }

      .video-title {
        font-size: 1.2em;
        margin-bottom: 10px;
      }

      .video-info {
        color: #666;
        font-size: 0.9em;
        margin: 10px 0;
      }

      .vote-button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 5px 15px;
        border-radius: 4px;
        cursor: pointer;
      }

      .vote-button:disabled {
        background: #ccc;
      }

      .vote-count {
        margin-left: 10px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>影片分享平台</h1>

    <div id="upload-section">
      <h2>上傳新影片</h2>
      <form id="upload-form">
        <input
          type="text"
          id="custom-filename"
          placeholder="請輸入影片名稱"
          required
        />
        <input type="file" id="video-file" accept=".mp4,.mov,.avi" required />
        <button type="submit">上傳</button>
      </form>
      <div id="upload-status"></div>
    </div>

    <div id="videos-section">
      {% if videos %} {% for video in videos %}
      <div class="video-container" data-video-id="{{ video.id }}">
        <div class="video-title">{{ video.title }}</div>
        <video width="320" height="240" controls>
          <source src="/uploads/{{ video.filename }}" type="video/mp4" />
          您的瀏覽器不支持影片播放。
        </video>
        <div class="video-info">
          觀看次數: <span class="view-count">{{ video.views }}</span>
          <br />
          上傳時間: {{ video.upload_time|datetime }}
        </div>
        <button class="vote-button" onclick="voteVideo({{ video.id }})">
          投票
        </button>
        <span class="vote-count">{{ video.votes }} 票</span>
      </div>
      {% endfor %} {% else %}
      <p>目前沒有可用的影片。</p>
      {% endif %}
    </div>

    <script>
      // 上傳功能
      document.getElementById("upload-form").onsubmit = async function (e) {
        e.preventDefault();

        const formData = new FormData();
        const customFilename = document.getElementById("custom-filename").value;
        const file = document.getElementById("video-file").files[0];

        formData.append("custom_filename", customFilename);
        formData.append("video", file);

        const status = document.getElementById("upload-status");
        status.textContent = "上傳中...";

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            status.textContent = "上傳成功！";
            location.reload(); // 重新載入頁面以顯示新影片
          } else {
            status.textContent = "上傳失敗: " + result.error;
          }
        } catch (error) {
          status.textContent = "上傳出錯: " + error;
        }
      };

      // 投票功能
      async function voteVideo(videoId) {
        const button = event.target;
        const container = button.closest(".video-container");
        const voteCount = container.querySelector(".vote-count");

        button.disabled = true;

        try {
          const response = await fetch(`/vote/${videoId}`, {
            method: "POST",
          });

          const result = await response.json();

          if (result.success) {
            voteCount.textContent = `${result.votes} 票`;
          } else {
            alert("投票失敗: " + result.error);
          }
        } catch (error) {
          alert("投票出錯: " + error);
        } finally {
          button.disabled = false;
        }
      }
    </script>
  </body>
</html>
