<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¹´åº¦å½±ç‰‡å¤§æ¯”æ‹š</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: #000;
        color: #fff;
      }

      .upload-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
      }

      #fileInput {
        display: none;
      }

      .upload-btn {
        background-color: rgba(0, 149, 246, 0.9);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 24px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .upload-btn:hover {
        background-color: rgba(0, 149, 246, 1);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .upload-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .upload-btn::before {
        content: "ğŸ“¤";
        font-size: 20px;
      }

      .video-container {
        height: 100vh;
        width: 100vw;
        position: relative;
        overflow: hidden;
      }

      .video-item {
        height: 100%;
        width: 100%;
        display: none;
        position: relative;
        z-index: 1000;
      }

      .video-item.active {
        display: block;
      }

      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        pointer-events: none;
      }

      .video-controls {
        position: absolute;
        bottom: 80px;
        left: 0;
        right: 0;
        padding: 20px;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
        z-index: 1002;
      }

      .navigation-controls {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        transform: translateY(-50%);
        display: flex;
        justify-content: space-between;
        padding: 0 20px;
        z-index: 1005;
      }

      .nav-btn {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .nav-btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .video-info {
        position: absolute;
        top: 20px;
        left: 20px;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        color: white;
      }

      .vote-btn {
        background-color: #ff4757;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 20px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.3s;
      }

      .vote-btn.voted {
        background-color: #2ed573;
      }

      .vote-btn::before {
        content: "ğŸ‘";
        font-size: 16px;
      }

      .vote-btn.voted::before {
        content: "âœ“";
      }

      .progress-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        gap: 4px;
        padding: 10px;
        z-index: 1000;
      }

      .progress-item {
        flex: 1;
        height: 2px;
        background-color: rgba(255, 255, 255, 0.3);
        position: relative;
      }

      .progress-item .progress-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        width: 0%;
      }

      .progress-item.viewed .progress-bar {
        width: 100%;
      }

      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 10px;
        display: none;
        text-align: center;
        z-index: 2000;
        min-width: 200px;
        color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .loading-progress {
        margin-top: 10px;
        font-size: 14px;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 10px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .upload-form-container {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.9);
        padding: 20px;
        border-radius: 10px;
        z-index: 2000;
        width: 90%;
        max-width: 400px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: white;
      }

      .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #444;
        border-radius: 4px;
        background-color: #333;
        color: white;
      }

      .form-text {
        color: #888;
        font-size: 12px;
        margin-top: 4px;
      }

      .btn-primary {
        background-color: #0095f6;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .btn-primary:hover {
        background-color: #0081d6;
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
      }

      .video-title {
        position: absolute;
        top: 60px;
        left: 20px;
        right: 20px;
        text-align: center;
        background-color: transparent;
        color: rgba(255, 255, 255, 0.8);
        padding: 10px;
        font-size: 14px;
        z-index: 10;
        font-family: "Microsoft JhengHei", sans-serif;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      }

      .side-nav {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 25%;
        cursor: pointer;
        z-index: 1005;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: auto;
      }

      .side-nav:hover {
        opacity: 0.1;
        background-color: rgba(255, 255, 255, 0.2);
      }

      .side-nav.prev {
        left: 0;
      }

      .side-nav.next {
        right: 0;
      }
    </style>
  </head>
  <body>
    <div
      id="welcomeModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 3000;
      "
    >
      <div
        style="
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 20px;
          border-radius: 10px;
          max-width: 80%;
          width: 400px;
          text-align: center;
          font-family: 'Microsoft JhengHei', sans-serif;
        "
      >
        <h2 style="color: #000a96; margin-bottom: 14px">2024å¹´åº¦å½±ç‰‡æ¯”è³½</h2>
        <p style="color: #474747; line-height: 1.6">
          åœ¨é€™è£¡æœ‰å¤§å®¶ç²¾å¿ƒæŒ‘é¸çš„ä»Šå¹´ç•¶ä¸­æœ€ç¶“å…¸çš„ä»£è¡¨å½±ç‰‡ï¼Œè¬è¬ä½ é€™é€™éº¼å–œæ„›æˆ‘å€‘çš„å¥³å…’ï¼Œè«‹æŠ•ç¥è–ä¸€ç¥¨å§ã€‚
        </p>
        <button
          onclick="closeWelcomeModal()"
          style="
            background: #0095f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin-top: 15px;
            cursor: pointer;
          "
        >
          é–‹å§‹æŠ•ç¥¨
        </button>
      </div>
    </div>

    <div class="video-container" id="videoContainer">
      <!-- å½±ç‰‡å°‡åœ¨é€™è£¡å‹•æ…‹åŠ è¼‰ -->
    </div>

    <div class="progress-container" id="progressContainer">
      <!-- é€²åº¦æ¢å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <div class="navigation-controls">
      <button class="nav-btn" onclick="previousVideo()">â—€</button>
      <button class="nav-btn" onclick="nextVideo()">â–¶</button>
    </div>

    <div class="upload-container">
      <button class="upload-btn" onclick="showUploadForm()">ä¸Šå‚³å½±ç‰‡</button>
    </div>

    <div class="loading" id="loading">
      <div class="loading-progress" id="loadingProgress">
        <div class="loading-spinner"></div>
        <div>æº–å‚™ä¸Šå‚³...</div>
        <small style="color: #999">è«‹ç¨å€™</small>
      </div>
    </div>

    <div class="upload-form-container" id="uploadFormContainer">
      <button class="close-btn" onclick="closeUploadForm()">Ã—</button>
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="custom_filename">æª”æ¡ˆåç¨±ï¼š</label>
          <input
            type="text"
            id="custom_filename"
            name="custom_filename"
            class="form-control"
            required
          />
          <small class="form-text text-muted"
            >è«‹è¼¸å…¥æƒ³è¦çš„æª”æ¡ˆåç¨±ï¼ˆä¸éœ€è¦åŒ…å«å‰¯æª”åï¼‰</small
          >
        </div>
        <div class="form-group">
          <label for="video">é¸æ“‡å½±ç‰‡ï¼š</label>
          <input
            type="file"
            id="video"
            name="video"
            accept=".mp4,.mov,.avi"
            class="form-control"
            required
          />
          <small class="form-text text-muted"
            >æ”¯æ´çš„æ ¼å¼ï¼šMP4, MOV, AVIï¼ˆæœ€å¤§ 100MBï¼‰</small
          >
        </div>
        <button type="submit" class="btn-primary">ä¸Šå‚³</button>
      </form>
    </div>

    <script>
      let currentVideoIndex = 0;
      let videos = [];
      let isPlaying = true;

      // æª¢æŸ¥æ˜¯å¦ç‚ºç¬¬ä¸€æ¬¡è¨ªå•
      function checkFirstVisit() {
        if (!localStorage.getItem("hasVisited")) {
          document.getElementById("welcomeModal").style.display = "block";
          localStorage.setItem("hasVisited", "true");
        }
      }

      function closeWelcomeModal() {
        document.getElementById("welcomeModal").style.display = "none";
      }

      // åœ¨é é¢åŠ è¼‰æ™‚æª¢æŸ¥
      window.onload = function () {
        checkFirstVisit();
        loadVideos();
      };

      // åŠ è¼‰æ‰€æœ‰å½±ç‰‡
      async function loadVideos() {
        const response = await fetch("/videos");
        videos = await response.json();
        if (videos.length > 0) {
          createProgressBars();
          showVideo(0);
        }
      }

      // å‰µå»ºæ‰€æœ‰é€²åº¦æ¢
      function createProgressBars() {
        const container = document.getElementById("progressContainer");
        container.innerHTML = "";

        videos.forEach((_, index) => {
          const progressItem = document.createElement("div");
          progressItem.className = "progress-item";
          if (index < currentVideoIndex) {
            progressItem.className += " viewed";
          }

          const progressBar = document.createElement("div");
          progressBar.className = "progress-bar";

          progressItem.appendChild(progressBar);
          container.appendChild(progressItem);
        });
      }

      // æ›´æ–°ç•¶å‰é€²åº¦æ¢
      function updateProgressBar(video) {
        const progressBars = document.querySelectorAll(".progress-item");
        const currentProgress =
          progressBars[currentVideoIndex].querySelector(".progress-bar");
        const progress = (video.currentTime / video.duration) * 100;
        currentProgress.style.width = `${progress}%`;
      }

      // é¡¯ç¤ºç‰¹å®šç´¢å¼•çš„å½±ç‰‡
      function showVideo(index) {
        const videoContainer = document.getElementById("videoContainer");
        videoContainer.innerHTML = "";

        if (videos.length === 0) return;

        const videoItem = document.createElement("div");
        videoItem.className = "video-item active";

        const video = document.createElement("video");
        video.src = `/uploads/${videos[index].filename}`;
        video.autoplay = true;
        video.loop = false;
        video.muted = false;
        video.playsInline = true;

        // è¨˜éŒ„è§€çœ‹æ¬¡æ•¸
        video.onplay = async () => {
          try {
            await fetch(`/view/${videos[index].filename}`, {
              method: "POST",
            });
          } catch (error) {
            console.error("ç„¡æ³•è¨˜éŒ„è§€çœ‹æ¬¡æ•¸:", error);
          }
        };

        const videoInfo = document.createElement("div");
        videoInfo.className = "video-info";
        videoInfo.textContent = videos[index].title;

        const controls = document.createElement("div");
        controls.className = "video-controls";

        const voteBtn = document.createElement("button");
        voteBtn.className = "vote-btn";
        if (videos[index].voted) {
          voteBtn.classList.add("voted");
        }
        voteBtn.innerHTML = `
                æŠ•ç¥¨
                <span class="vote-count">${videos[index].votes}</span>
            `;

        voteBtn.onclick = async (event) => {
          event.stopPropagation();
          try {
            const response = await fetch(`/vote/${videos[index].filename}`, {
              method: "POST",
            });
            const data = await response.json();

            // æ›´æ–°æœ¬åœ°å­˜å„²çš„æŠ•ç¥¨ç‹€æ…‹
            videos[currentVideoIndex].votes = data.votes;
            videos[currentVideoIndex].voted = data.voted; // æ›´æ–°æŠ•ç¥¨ç‹€æ…‹

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            if (data.voted) {
              voteBtn.classList.add("voted");
            } else {
              voteBtn.classList.remove("voted");
            }

            voteBtn.innerHTML = `
                æŠ•ç¥¨
                <span class="vote-count">${data.votes}</span>
            `;
          } catch (error) {
            console.error("æŠ•ç¥¨å¤±æ•—:", error);
            alert("æŠ•ç¥¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
          }
        };

        // æ·»åŠ é»æ“Šæš«åœ/æ’­æ”¾åŠŸèƒ½
        videoItem.onclick = (event) => {
          // ç¢ºä¿é»æ“Šä¸æ˜¯ä¾†è‡ªå´é‚Šå°èˆª
          if (!event.target.classList.contains("side-nav")) {
            if (video.paused) {
              video.play();
              isPlaying = true;
            } else {
              video.pause();
              isPlaying = false;
            }
          }
        };

        controls.appendChild(voteBtn);
        videoItem.appendChild(video);
        videoItem.appendChild(videoInfo);
        videoItem.appendChild(controls);
        videoContainer.appendChild(videoItem);

        if (!isPlaying) {
          video.pause();
        } else {
          video.play();
        }

        // å½±ç‰‡çµæŸæ™‚æ’­æ”¾ä¸‹ä¸€å€‹
        video.onended = () => {
          const progressBars = document.querySelectorAll(".progress-item");
          progressBars[currentVideoIndex].className = "progress-item viewed";
          nextVideo();
        };

        // æ›´æ–°é€²åº¦æ¢
        video.ontimeupdate = () => {
          updateProgressBar(video);
        };

        // æ›´æ–°æ‰€æœ‰é€²åº¦æ¢çš„ç‹€æ…‹
        const progressBars = document.querySelectorAll(".progress-item");
        progressBars.forEach((bar, i) => {
          if (i < index) {
            // å°‡ä¹‹å‰çš„å½±ç‰‡é€²åº¦æ¢éƒ½è¨­å·²å®Œæˆ
            bar.className = "progress-item viewed";
            const progressBar = bar.querySelector(".progress-bar");
            progressBar.style.width = "100%";
          } else if (i > index) {
            // é‡ç½®å¾Œé¢çš„å½±ç‰‡é€²é€²åº¦æ¢
            bar.className = "progress-item";
            const progressBar = bar.querySelector(".progress-bar");
            progressBar.style.width = "0%";
          }
        });
      }

      // åˆ‡æ›åˆ°ä¸‹ä¸€å€‹å½±ç‰‡
      function nextVideo() {
        if (videos.length <= 1) return;

        // å°‡ç•¶å‰å½±ç‰‡çš„é€²åº¦æ¢ç‚ºå®Œæˆ
        const progressBars = document.querySelectorAll(".progress-item");
        const currentProgress = progressBars[currentVideoIndex];
        currentProgress.className = "progress-item viewed";
        const progressBar = currentProgress.querySelector(".progress-bar");
        progressBar.style.width = "100%";

        currentVideoIndex = (currentVideoIndex + 1) % videos.length;
        showVideo(currentVideoIndex);
      }

      // åˆ‡æ›åˆ°ä¸Šä¸€å€‹å½±ç‰‡
      function previousVideo() {
        if (videos.length <= 1) return;

        // é‡ç½®ç•¶å‰å½±ç‰‡çš„é€²åº¦æ¢
        const progressBars = document.querySelectorAll(".progress-item");
        const currentProgress = progressBars[currentVideoIndex];
        currentProgress.className = "progress-item";
        const progressBar = currentProgress.querySelector(".progress-bar");
        progressBar.style.width = "0%";

        currentVideoIndex =
          (currentVideoIndex - 1 + videos.length) % videos.length;
        showVideo(currentVideoIndex);
      }

      function showUploadForm() {
        document.getElementById("uploadFormContainer").style.display = "block";
      }

      function closeUploadForm() {
        document.getElementById("uploadFormContainer").style.display = "none";
      }

      // ä¿®æ”¹ä¸Šå‚³è¡¨å–®çš„æäº¤è™•ç†
      document.getElementById("uploadForm").onsubmit = async function (e) {
        e.preventDefault();

        const formData = new FormData();
        const videoFile = document.getElementById("video").files[0];
        const customFilename = document
          .getElementById("custom_filename")
          .value.trim();

        if (!videoFile) {
          alert("è«‹é¸æ“‡å½±ç‰‡æª”æ¡ˆ");
          return;
        }

        if (!customFilename) {
          alert("è«‹è¼¸å…¥æª”æ¡ˆåç¨±");
          return;
        }

        // æª¢æŸ¥æª”æ¡ˆå¤§å°
        if (videoFile.size > 100 * 1024 * 1024) {
          alert("æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 100MB");
          return;
        }

        formData.append("video", videoFile);
        formData.append("custom_filename", customFilename);

        // é—œé–‰ä¸Šå‚³è¡¨å–®
        closeUploadForm();

        // é¡¯ç¤ºä¸Šå‚³ä¸­çš„æç¤º
        const loadingEl = document.getElementById("loading");
        const progressEl = document.getElementById("loadingProgress");
        loadingEl.style.display = "block";
        progressEl.innerHTML = `
            <div class="loading-spinner"></div>
            <div style="font-size: 16px; margin: 10px 0;">å½±ç‰‡ä¸Šå‚³ä¸­...</div>
            <small style="color: #999">è«‹å‹¿é—œé–‰è¦–çª—ï¼Œä¸Šå‚³å®Œæˆå¾Œæœƒè‡ªå‹•è™•ç†</small>
        `;

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (data.success) {
            progressEl.innerHTML = `
                    <div style="color: #2ecc71; font-size: 40px; margin: 10px 0;">âœ“</div>
                    <div style="font-size: 16px;">ä¸Šå‚³æˆåŠŸï¼</div>
                    <small style="color: #999">é é¢å³å°‡é‡æ–°æ•´ç†</small>
                `;
            setTimeout(() => {
              document.querySelector(".upload-container").style.display =
                "none";
              location.reload();
            }, 1500);
          } else {
            progressEl.innerHTML = `
                    <div style="color: #e74c3c; font-size: 40px; margin: 10px 0;">âœ—</div>
                    <div style="font-size: 16px;">${
                      data.error || "ä¸Šå‚³å¤±æ•—"
                    }</div>
                `;
            setTimeout(() => {
              loadingEl.style.display = "none";
            }, 1500);
          }
        } catch (error) {
          console.error("Error:", error);
          progressEl.innerHTML = `
                <div style="color: #e74c3c; font-size: 40px; margin: 10px 0;">âœ—</div>
                <div style="font-size: 16px;">ä¸Šå‚³æ™‚ç™¼ç”ŸéŒ¯èª¤</div>
            `;
          setTimeout(() => {
            loadingEl.style.display = "none";
          }, 1500);
        }
      };
    </script>
  </body>
</html>
