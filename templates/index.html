<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />
    <title>å¹´åº¦å½±ç‰‡å¤§æ¯”æ‹š</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
      }

      body {
        background-color: #000;
        color: #fff;
      }

      .upload-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        align-items: flex-end;
        z-index: 1000;
      }

      #fileInput {
        display: none;
      }

      .upload-btn {
        background-color: rgba(0, 149, 246, 0.9);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 24px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .upload-btn:hover {
        background-color: rgba(0, 149, 246, 1);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .upload-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .upload-btn::before {
        content: "ğŸ“¤";
        font-size: 20px;
      }

      .video-container {
        position: relative;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
      }

      .video-item {
        height: 100%;
        width: 100%;
        display: none;
        position: relative;
        z-index: 1000;
      }

      .video-item.active {
        display: block;
      }

      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        pointer-events: none;
      }

      .video-controls {
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1002;
        pointer-events: none;
      }

      .navigation-controls {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        transform: translateY(-50%);
        display: flex;
        justify-content: space-between;
        padding: 0 20px;
        z-index: 1005;
      }

      .nav-btn {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .nav-btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .video-info {
        position: absolute;
        top: 20px;
        left: 20px;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        color: white;
      }

      .vote-btn {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background-color: #ff4757;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 24px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        pointer-events: auto;
      }

      .vote-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .vote-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .vote-btn::before {
        content: "ğŸ‘";
        font-size: 16px;
      }

      .vote-btn.voted::before {
        content: "âœ“";
      }

      .vote-btn.voted {
        background-color: #2ed573;
      }

      .vote-btn {
        margin-left: 0;
      }

      .video-controls {
        display: true;
      }

      .progress-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        gap: 2px;
        padding: 0;
        z-index: 1000;
        background-color: rgba(0, 0, 0, 0.2);
      }

      .progress-item {
        flex: 1;
        height: 4px;
        background-color: rgba(255, 255, 255, 0.3);
        position: relative;
        margin: 0 2px;
      }

      /* åœ¨æ‰‹æ©Ÿç‰ˆç‰¹åˆ¥èª¿æ•´ */
      @media (max-width: 768px) {
        .progress-item {
          height: 6px;
          margin: 0 3px;
        }
      }

      .progress-item .progress-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        width: 0%;
      }

      .progress-item.viewed .progress-bar {
        width: 100%;
      }

      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 10px;
        display: none;
        text-align: center;
        z-index: 1500;
        min-width: 200px;
        color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .loading-progress {
        margin-top: 10px;
        font-size: 14px;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 10px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .upload-form-container {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.9);
        padding: 20px;
        border-radius: 10px;
        z-index: 2000;
        width: 90%;
        max-width: 400px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: white;
      }

      .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #444;
        border-radius: 4px;
        background-color: #333;
        color: white;
      }

      .form-text {
        color: #888;
        font-size: 12px;
        margin-top: 4px;
      }

      .btn-primary {
        background-color: #0095f6;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .btn-primary:hover {
        background-color: #0081d6;
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
      }

      .video-title {
        position: absolute;
        top: 60px;
        left: 20px;
        right: 20px;
        text-align: center;
        background-color: transparent;
        color: rgba(255, 255, 255, 0.8);
        padding: 10px;
        font-size: 14px;
        z-index: 10;
        font-family: "Microsoft JhengHei", sans-serif;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      }

      .side-nav {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 25%;
        cursor: pointer;
        z-index: 1005;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: auto;
      }

      .side-nav:hover {
        opacity: 0.1;
        background-color: rgba(255, 255, 255, 0.2);
      }

      .side-nav.prev {
        left: 0;
      }

      .side-nav.next {
        right: 0;
      }

      .play-hint {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.7);
        padding: 20px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        z-index: 1010;
      }

      .play-icon {
        font-size: 40px;
        color: white;
      }

      .play-text {
        color: white;
        font-size: 16px;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 3000;
      }

      .loading-overlay .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      .loading-overlay .loading-text {
        color: white;
        font-size: 18px;
        font-family: "Microsoft JhengHei", sans-serif;
      }

      .processing-hint {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 1010;
      }

      .processing-hint .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .processing-hint .hint-text {
        color: white;
        font-size: 14px;
      }

      .rankings-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        transition: all 0.3s ease;
      }

      .rankings-container.collapsed .rankings-content {
        display: none;
      }

      .rankings-toggle {
        width: 40px;
        height: 40px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease;
      }

      .rankings-toggle:hover {
        transform: scale(1.1);
      }

      .rankings-content {
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 10px;
        margin-top: 10px;
        min-width: 300px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .rankings-header {
        text-align: center;
        margin-bottom: 15px;
        width: 100%;
      }

      .rankings-header h3 {
        color: #fff;
        font-size: 16px;
        margin: 0;
        display: inline-block;
      }

      .rankings-list {
        width: 100%;
      }

      .ranking-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 5px;
        transition: background-color 0.2s;
      }

      .ranking-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .ranking-thumbnail {
        width: 60px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
        background-color: rgba(255, 255, 255, 0.1);
      }

      .ranking-position {
        font-weight: bold;
        color: #ffd700;
        width: 20px;
      }

      .ranking-title {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #fff;
      }

      .ranking-votes {
        color: #69ff47;
        font-weight: bold;
      }

      .intro-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.5s ease;
      }

      .intro-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .intro-container.hidden {
        display: none;
      }

      .welcome-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
      }

      .welcome-content {
        background: white;
        text-align: center;
        padding: 40px;
        max-width: 600px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .welcome-content h2 {
        color: #000a96;
        margin-bottom: 20px;
        font-size: 24px;
      }

      .welcome-content p {
        color: #474747;
        line-height: 1.6;
        margin-bottom: 30px;
      }

      .start-btn {
        background-color: #000a96;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 24px;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .welcome-container.hidden {
        display: none;
      }

      /* ç¢ºä¿ç‰¹å®šå…ƒç´ ä¹Ÿä½¿ç”¨ç›¸åŒå­—é«” */
      .welcome-content h2,
      .welcome-content p,
      .video-info,
      .vote-btn,
      .upload-btn,
      .loading-text,
      .play-text,
      .form-group label,
      .form-control,
      .form-text,
      .video-title,
      .ranking-title,
      .rankings-header h3 {
        font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
      }

      /* ç§»é™¤å…¶ä»–åœ°æ–¹çš„å­—é«”è¨­å®š */
      .video-title {
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      }

      /* é˜²æ­¢ iOS ç¸®æ”¾ */
      input[type="text"],
      input[type="number"],
      textarea {
        font-size: 16px; /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾çš„æœ€å°å­—å¤§å° */
        max-height: 100%;
        -webkit-text-size-adjust: 100%;
      }

      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 10px;
        display: none;
        text-align: center;
        z-index: 1500;
        min-width: 200px;
        color: white;
      }

      .upload-progress {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.9);
        padding: 30px;
        border-radius: 15px;
        display: none;
        text-align: center;
        z-index: 2000;
        min-width: 300px;
        color: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .upload-text {
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <div id="welcomeContainer" class="welcome-container">
      <div class="welcome-content">
        <h2>2024å¹´åº¦ä»£è¡¨å½±ç‰‡å¤§è³½</h2>
        <p>
          åœ¨é€™è£¡æœ‰å¤§å®¶ç²¾å¿ƒæŒ‘é¸çš„ä»Šå¹´ç•¶ä¸­æœ€ç¶“å…¸çš„ä»£è¡¨å½±ç‰‡ï¼Œè¬è¬ä½ é€™é€™éº¼å–œæ„›æˆ‘å€‘çš„å¯¶è²ï¼Œè«‹æ ¹æ“šä½ çš„æœ€æ„›æŠ•å‡ºæœ€å…·ä»£è¡¨æ€§çš„ä¸€ç¥¨å§ã€‚
        </p>
        <button id="startButton" class="start-btn">é–‹å§‹æŠ•ç¥¨</button>
      </div>
    </div>

    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">å½±ç‰‡è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
    </div>

    <div id="uploadProgress" class="upload-progress">
      <div class="loading-spinner"></div>
      <div id="uploadProgressText" class="upload-text"></div>
    </div>

    <div id="introContainer" class="intro-container">
      <video id="introVideo" src="/static/intro.mp4" playsinline></video>
    </div>

    <div class="video-container" id="videoContainer">
      <!-- å½±ç‰‡å°‡åœ¨é€™è£¡å‹•æ…‹åŠ è¼‰ -->
    </div>

    <div class="progress-container" id="progressContainer">
      <!-- é€²åº¦æ¢å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <div class="navigation-controls">
      <button class="nav-btn" onclick="previousVideo()">â—€</button>
      <button class="nav-btn" onclick="nextVideo()">â–¶</button>
    </div>

    <div class="upload-container">
      <button class="upload-btn" onclick="showUploadForm()">ä¸Šå‚³å½±ç‰‡</button>
    </div>

    <div class="upload-form-container" id="uploadFormContainer">
      <button class="close-btn" onclick="closeUploadForm()">Ã—</button>
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="custom_filename">æª”æ¡ˆåç¨±ï¼š</label>
          <input
            type="text"
            id="custom_filename"
            name="custom_filename"
            class="form-control"
            required
          />
          <small class="form-text text-muted"
            >è«‹è¼¸å…¥æƒ³è¦çš„æª”æ¡ˆåç¨±ï¼ˆä¸éœ€è¦åŒ…å«å‰¯æª”åï¼‰</small
          >
        </div>
        <div class="form-group">
          <label for="video">é¸æ“‡å½±ç‰‡ï¼š</label>
          <input
            type="file"
            id="video"
            name="video"
            accept=".mp4,.mov,.avi"
            class="form-control"
            required
          />
          <small class="form-text text-muted"
            >æ”¯æ´çš„æ ¼å¼ï¼šMP4, MOV, AVIï¼ˆæœ€å¤§ 100MBï¼‰</small
          >
        </div>
        <button type="submit" class="btn-primary">ä¸Šå‚³</button>
      </form>
    </div>

    <div class="rankings-container collapsed">
      <div class="rankings-toggle">
        <span>ğŸ†</span>
      </div>
      <div class="rankings-content">
        <div class="rankings-header">
          <h3>äººæ°£æ’è¡Œæ¦œ</h3>
        </div>
        <div class="rankings-list"></div>
      </div>
    </div>

    <div id="preloadContainer" style="display: none"></div>

    <script>
      let currentVideoIndex = 0;
      let videos = [];
      let isPlaying = true;
      let isMuted = true;
      let isUploading = false;

      function showLoading() {
        document.getElementById("loading").style.display = "block";
      }

      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }

      function showUploadProgress(message) {
        const uploadProgress = document.getElementById("uploadProgress");
        const uploadProgressText =
          document.getElementById("uploadProgressText");
        uploadProgress.style.display = "block";
        uploadProgressText.innerHTML = message;
      }

      function hideUploadProgress() {
        document.getElementById("uploadProgress").style.display = "none";
      }

      // æª¢æŸ¥æ˜¯å¦ç‚ºç¬¬ä¸€æ¬¡è¨ªå•
      function checkFirstVisit() {
        if (!localStorage.getItem("hasVisited")) {
          document.getElementById("welcomeContainer").style.display = "block";
          localStorage.setItem("hasVisited", "true");
        }
      }

      function closeWelcomeModal() {
        document.getElementById("welcomeContainer").style.display = "none";
      }

      // æ·»åŠ é åŠ è¼‰å‡½æ•¸
      async function preloadVideos() {
        try {
          const response = await fetch("/videos");
          const data = await response.json();
          videos = data;

          if (videos.length > 0) {
            const preloadContainer =
              document.getElementById("preloadContainer");
            const preloadPromises = videos.map((video) => {
              return new Promise((resolve, reject) => {
                const videoElement = document.createElement("video");
                videoElement.src = `/uploads/${video.filename}`;
                videoElement.preload = "auto";

                videoElement.addEventListener("canplaythrough", () => {
                  resolve();
                });

                videoElement.addEventListener("error", () => {
                  reject(new Error(`Failed to load video: ${video.filename}`));
                });

                preloadContainer.appendChild(videoElement);
              });
            });

            // ç­‰å¾…æ‰€æœ‰å½±ç‰‡åŠ è¼‰å®Œæˆ
            await Promise.all(preloadPromises);
          }
        } catch (error) {
          console.error("é åŠ è¼‰å½±ç‰‡å¤±æ•—:", error);
        }
      }

      // ä¿®æ”¹åˆå§‹åŒ–éƒ¨åˆ†
      window.onload = function () {
        checkFirstVisit();
        const introVideo = document.getElementById("introVideo");
        const introContainer = document.getElementById("introContainer");
        const welcomeContainer = document.getElementById("welcomeContainer");

        // ç§»é™¤è‡ªå‹•æ’­æ”¾å±¬æ€§ï¼Œç­‰å¾…é»æ“Šé–‹å§‹æŒ‰éˆ•
        introVideo.autoplay = false;
        introVideo.muted = true;

        // é»æ“Šé–‹å§‹æŒ‰éˆ•çš„è™•ç†
        document.getElementById("startButton").addEventListener("click", () => {
          welcomeContainer.classList.add("hidden");
          introVideo.muted = false;
          introVideo.play();

          // é–‹å§‹é åŠ è¼‰å½±ç‰‡
          preloadVideos();

          introVideo.onended = () => {
            introContainer.style.opacity = 0;
            setTimeout(() => {
              introContainer.classList.add("hidden");
              // æ¥é¡¯ç¤ºå½±ç‰‡ï¼Œä¸éœ€è¦é‡æ–°åŠ è¼‰
              if (videos.length > 0) {
                createProgressBars();
                showVideo(currentVideoIndex);
              }
            }, 500);
          };
        });
      };

      // ä¿®æ”¹ loadVideos å‡½æ•¸
      async function loadVideos() {
        try {
          const response = await fetch("/videos");
          videos = await response.json();

          if (videos.length > 0) {
            createProgressBars();

            // å‰µå»ºå½±ç‰‡å…ƒç´ 
            const videoContainer = document.querySelector(".video-container");
            videos.forEach((videoData, index) => {
              const videoItem = document.createElement("div");
              videoItem.className = `video-item ${index === 0 ? "active" : ""}`;
              videoItem.innerHTML = `
                    <video playsinline loop>
                        <source src="/uploads/${videoData.filename}" type="video/mp4">
                    </video>
                    <div class="video-info">
                        <div class="video-title">${videoData.title}</div>
                        <div class="video-stats">
                            <span>ğŸ‘ï¸ ${videoData.views}</span>
                        </div>
                    </div>
                `;
              videoContainer.appendChild(videoItem);
            });

            // åˆå§‹åŒ–ç¬¬ä¸€å€‹å½±ç‰‡
            currentVideoIndex = 0;
            const firstVideo = document.querySelector(
              ".video-item.active video"
            );

            // åˆå§‹åŒ–æŠ•ç¥¨æŒ‰éˆ•
            updateVoteButton(voteBtn, videos[0].voted, videos[0].votes);

            // è¼‰å…¥ç¬¬ä¸€å€‹å½±ç‰‡
            loadVideo(0);
          }
        } catch (error) {
          console.error("è¼‰å…¥å½±ç‰‡å¤±æ•—:", error);
        }
      }

      // ä¿®æ”¹åˆ‡æ›å½±ç‰‡å‡½æ•¸
      function switchVideo(direction) {
        const currentVideo = document.querySelector(".video-item.active video");
        currentVideo.pause();

        const items = document.querySelectorAll(".video-item");
        items[currentVideoIndex].classList.remove("active");

        currentVideoIndex =
          (currentVideoIndex + direction + videos.length) % videos.length;
        items[currentVideoIndex].classList.add("active");

        // è¼‰å…¥æ–°çš„å½±ç‰‡
        loadVideo(currentVideoIndex);

        // æ›´æ–°æŠ•ç¥¨æŒ‰éˆ•ç‹€æ…‹
        updateVoteButton(
          voteBtn,
          videos[currentVideoIndex].voted,
          videos[currentVideoIndex].votes
        );
        updateProgressBar();
      }

      // ä¿®æ”¹å½±ç‰‡è¼‰å…¥å‡½æ•¸
      function loadVideo(index) {
        const videoElement = document.querySelector(".video-item.active video");
        console.log("è¼‰å…¥å½±ç‰‡:", index);

        // é‡ç½®è§€çœ‹è¿½è¹¤
        viewTracking = {
          startTime: null,
          hasRecorded: false,
          minViewDuration: 5,
        };

        // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
        const newVideo = videoElement.cloneNode(true);
        videoElement.parentNode.replaceChild(newVideo, videoElement);

        // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
        newVideo.addEventListener("play", () => {
          console.log("å½±ç‰‡é–‹å§‹æ’­æ”¾");
          viewTracking.startTime = Date.now();
        });

        newVideo.addEventListener("timeupdate", () => {
          if (
            !viewTracking.hasRecorded &&
            viewTracking.startTime &&
            !newVideo.paused
          ) {
            const duration = (Date.now() - viewTracking.startTime) / 1000;
            console.log("æ’­æ”¾æ™‚é–“:", duration);

            if (duration >= viewTracking.minViewDuration) {
              console.log("è¨˜éŒ„è§€çœ‹");
              recordView(videos[index].filename);
              viewTracking.hasRecorded = true;
            }
          }
        });

        // è¨­ç½®å½±ç‰‡éœéŸ³ç‹€æ…‹
        newVideo.muted = true;

        // è‡ªå‹•æ’­æ”¾
        newVideo.play().catch((error) => {
          console.error("è‡ªå‹•æ’­æ”¾å¤±æ•—:", error);
        });
      }

      // ä¿®æ”¹è§€çœ‹è¨˜éŒ„å‡½æ•¸
      async function recordView(filename) {
        try {
          const fingerprint = generateFingerprint();
          console.log("ç™¼é€è§€çœ‹è¨˜éŒ„:", filename, fingerprint);

          const response = await fetch(`/view/${filename}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Device-Fingerprint": fingerprint,
            },
          });

          const data = await response.json();
          console.log("è§€çœ‹è¨˜éŒ„å›æ‡‰:", data);

          if (response.ok) {
            // æ›´æ–°é¡¯ç¤º
            videos[currentVideoIndex].views = data.views;
            const statsElement = document.querySelector(
              ".video-item.active .video-stats span"
            );
            if (statsElement) {
              statsElement.textContent = `ğŸ‘ï¸ ${data.views}`;
            }
          } else {
            throw new Error(data.error || "è¨˜éŒ„å¤±æ•—");
          }
        } catch (error) {
          console.error("è¨˜éŒ„è§€çœ‹æ¬¡æ•¸å¤±æ•—:", error);
        }
      }

      // å‰µå»ºæ‰€æœ‰é€²åº¦æ¢
      function createProgressBars() {
        const container = document.getElementById("progressContainer");
        container.innerHTML = "";

        videos.forEach((_, index) => {
          const progressItem = document.createElement("div");
          progressItem.className = "progress-item";
          if (index < currentVideoIndex) {
            progressItem.className += " viewed";
          }

          const progressBar = document.createElement("div");
          progressBar.className = "progress-bar";

          progressItem.appendChild(progressBar);
          container.appendChild(progressItem);
        });
      }

      // æ›´æ–°ç•¶å‰é€²åº¦æ¢
      function updateProgressBar(video) {
        const progressBars = document.querySelectorAll(".progress-item");
        const currentProgress =
          progressBars[currentVideoIndex].querySelector(".progress-bar");
        const progress = (video.currentTime / video.duration) * 100;
        currentProgress.style.width = `${progress}%`;
      }

      // é¡¯ç¤ºç‰¹å®šç´¢å¼•çš„å½±ç‰‡
      function showVideo(index) {
        const videoContainer = document.getElementById("videoContainer");
        const videoItems = document.querySelectorAll(".video-item");
        videoItems.forEach((item) => item.remove());

        const videoItem = document.createElement("div");
        videoItem.className = "video-item active";

        const video = document.createElement("video");
        video.src = `/uploads/${videos[index].filename}`;
        video.preload = "auto";
        video.autoplay = false; // å…ˆä¸è‡ªå‹•æ’­æ”¾
        video.muted = isMuted;
        video.playsInline = true;

        // ä¿®æ”¹åŠ è¼‰äº‹ä»¶è™•ç†
        video.addEventListener("loadedmetadata", () => {
          // åªæœ‰åœ¨éä¸Šå‚³ç‹€æ…‹æ™‚æ‰é¡¯ç¤ºåŠ è¼‰å‹•ç•«
          if (
            !isUploading &&
            document.querySelector(".intro-container.hidden")
          ) {
            showLoading("video");
          }
        });

        video.addEventListener("canplaythrough", () => {
          // åªæœ‰åœ¨éä¸Šå‚³ç‹€æ…‹æ™‚æ‰è™•ç†åŠ è¼‰å®Œæˆ
          if (!isUploading) {
            hideLoading("video");
            if (isPlaying) {
              video.play();
            }
          }
        });

        video.addEventListener("error", () => {
          if (!isUploading) {
            hideLoading("video");
            alert("å½±ç‰‡è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
          }
        });

        // æ·»åŠ æ’­æ”¾é–‹å§‹äº‹ä»¶è™•ç†
        video.onplay = async () => {
          try {
            // éŒ„è§€çœ‹æ¬¡æ•¸
            const response = await fetch(`/view/${videos[index].filename}`, {
              method: "POST",
            });
            const data = await response.json();
            videos[currentVideoIndex].views = data.views;
          } catch (error) {
            console.error("éŒ„è§€çœ‹æ¬¡æ•¸æ•—:", error);
          }
        };

        // åœ¨éœéŸ³ç‹€æ…‹ä¸‹é¡¯ç¤ºæç¤º
        const playHint = document.createElement("div");
        playHint.className = "play-hint";
        playHint.innerHTML = `
            <div class="play-icon">ğŸ”Š</div>
            <div class="play-text">é»æ“Šé–‹å•Ÿè²éŸ³</div>
        `;
        playHint.style.display = isMuted ? "flex" : "none";
        videoItem.appendChild(playHint);

        // ä¿®æ”¹é»æ“Šäº‹ä»¶è™•ç†
        videoItem.onclick = (event) => {
          if (!event.target.classList.contains("side-nav")) {
            if (video.muted) {
              video.muted = false;
              isMuted = false; // æ›´æ–°å…¨å±€éŸ³ç‹€æ…‹
              playHint.style.display = "none";
              isPlaying = true;
            } else {
              // å¦‚æœä¸æ˜¯éœéŸ³ç‹€æ…‹ï¼Œå‰‡åˆ‡æ›æ’­æ”¾/æš«åœ
              if (video.paused) {
                video.play();
                isPlaying = true;
              } else {
                video.pause();
                isPlaying = false;
              }
            }
          }
        };

        const videoInfo = document.createElement("div");
        videoInfo.className = "video-info";
        videoInfo.textContent = videos[index].title;

        const controls = document.createElement("div");
        controls.className = "video-controls";

        const voteBtn = document.createElement("button");
        voteBtn.className = "vote-btn";
        if (videos[index].voted) {
          voteBtn.classList.add("voted");
        }
        voteBtn.innerHTML = `
                æŠ•ç¥¨
                <span class="vote-count">${videos[index].votes}</span>
            `;

        voteBtn.onclick = async () => {
          try {
            const fingerprint = generateFingerprint();
            console.log("ç”Ÿæˆçš„æŒ‡ç´‹:", fingerprint);

            const response = await fetch(
              `/vote/${videos[currentVideoIndex].filename}`,
              {
                method: "POST",
                headers: {
                  "X-Device-Fingerprint": fingerprint,
                  "Content-Type": "application/json",
                },
              }
            );

            const data = await response.json();
            console.log("æŠ•ç¥¨å›æ‡‰:", data);

            if (response.ok) {
              // æ›´æ–°ç•¶å‰å½±ç‰‡çš„æŠ•ç¥¨æ•¸
              videos[currentVideoIndex].votes = data.votes;
              videos[currentVideoIndex].voted = data.voted;

              // å¦‚æœæœ‰ä¹‹å‰çš„æŠ•ç¥¨ï¼Œæ›´æ–°ä¹‹å‰å½±ç‰‡çš„ç‹€æ…‹
              if (data.previousVote) {
                const previousIndex = videos.findIndex(
                  (v) => v.id === data.previousVote
                );
                if (previousIndex !== -1) {
                  videos[previousIndex].voted = false;
                  videos[previousIndex].votes -= 1;
                }
              }

              // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
              updateVoteButton(voteBtn, data.voted, data.votes);

              // ä¸è¦é‡æ–°è¼‰å…¥å½±ç‰‡ï¼Œåªæ›´æ–°æŠ•ç¥¨ç‹€æ…‹
              const currentVideo = document.querySelector(
                ".video-item.active video"
              );
              if (currentVideo.paused) {
                currentVideo.play();
              }
            } else {
              console.error("æŠ•ç¥¨å¤±æ•—:", data.error);
              throw new Error(data.error || "æŠ•ç¥¨å¤±æ•—");
            }
          } catch (error) {
            console.error("æŠ•ç¥¨éŒ¯èª¤:", error);
            alert(error.message || "æŠ•ç¥¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
          }
        };

        controls.appendChild(voteBtn);
        videoItem.appendChild(video);
        videoItem.appendChild(videoInfo);
        videoItem.appendChild(controls);
        videoContainer.appendChild(videoItem);

        // ä¿®æ”¹åˆå§‹æ’­æ”¾ç‹€æ…‹
        if (!isPlaying) {
          video.pause();
        } else {
          video.play();
        }

        // å½±ç‰‡çµæŸæ™‚æ’­æ”¾ä¸‹ä¸€å€‹
        video.onended = () => {
          const progressBars = document.querySelectorAll(".progress-item");
          progressBars[currentVideoIndex].className = "progress-item viewed";
          nextVideo();
        };

        // æ›´æ–°é€²åº¦æ¢
        video.ontimeupdate = () => {
          updateProgressBar(video);
        };

        // æ›´æ–°æ‰€æœ‰é€²åº¦æ¢çš„ç‹€æ…‹
        const progressBars = document.querySelectorAll(".progress-item");
        progressBars.forEach((bar, i) => {
          if (i < index) {
            // å°‡ä¹‹å‰çš„å½±ç‰‡é€²åº¦æ¢éƒ½è¨­å·²å®Œæˆ
            bar.className = "progress-item viewed";
            const progressBar = bar.querySelector(".progress-bar");
            progressBar.style.width = "100%";
          } else if (i > index) {
            // é‡ç½®å¾Œé¢çš„å½±ç‰‡é€²é€²åº¦
            bar.className = "progress-item";
            const progressBar = bar.querySelector(".progress-bar");
            progressBar.style.width = "0%";
          }
        });
      }

      // åˆ‡æ›åˆ°ä¸‹ä¸€å€‹å½±ç‰‡
      function nextVideo() {
        if (videos.length <= 1) return;

        // å°‡ç•¶å‰å½±ç‰‡çš„é€²åº¦æ¢ç‚ºå®Œæˆ
        const progressBars = document.querySelectorAll(".progress-item");
        const currentProgress = progressBars[currentVideoIndex];
        currentProgress.className = "progress-item viewed";
        const progressBar = currentProgress.querySelector(".progress-bar");
        progressBar.style.width = "100%";

        currentVideoIndex = (currentVideoIndex + 1) % videos.length;
        showVideo(currentVideoIndex);
      }

      // åˆ‡æ›åˆ°ä¸Šä¸€å€‹å½±ç‰‡
      function previousVideo() {
        if (videos.length <= 1) return;

        // é‡ç½®ç•¶å‰å½±ç‰‡çš„é€²åº¦æ¢
        const progressBars = document.querySelectorAll(".progress-item");
        const currentProgress = progressBars[currentVideoIndex];
        currentProgress.className = "progress-item";
        const progressBar = currentProgress.querySelector(".progress-bar");
        progressBar.style.width = "0%";

        currentVideoIndex =
          (currentVideoIndex - 1 + videos.length) % videos.length;
        showVideo(currentVideoIndex);
      }

      function showUploadForm() {
        document.getElementById("uploadFormContainer").style.display = "block";
      }

      function closeUploadForm() {
        document.getElementById("uploadFormContainer").style.display = "none";
      }

      // ä¿®æ”¹æª¢æŸ¥å£“ç¸®ç‹€æ…‹çš„å‡½æ•¸
      async function checkCompressionStatus(filename) {
        try {
          // ç¢ºä¿æª”æ¡ˆåç¨±åŒ…å«å‰¯æª”å
          const fullFilename = filename.includes(".")
            ? filename
            : `${filename}.mp4`;
          console.log("æª¢æŸ¥æª”æ¡ˆ:", fullFilename);

          const response = await fetch(`/compression_status/${fullFilename}`);
          const data = await response.json();
          console.log("å£“ç¸®ç‹€æ…‹:", data.status);
          return data.status;
        } catch (error) {
          console.error("æª¢æŸ¥å£“ç¸®ç‹€æ…‹å¤±æ•—:", error);
          return "error";
        }
      }

      // ä¿®æ”¹ä¸Šå‚³è¡¨å–®è™•ç†
      document.getElementById("uploadForm").onsubmit = async function (e) {
        e.preventDefault();

        const formData = new FormData();
        const videoFile = document.getElementById("video").files[0];
        const customFilename = document
          .getElementById("custom_filename")
          .value.trim();

        if (!videoFile) {
          alert("è«‹é¸æ“‡å½±ç‰‡æª”æ¡ˆ");
          return;
        }

        if (!customFilename) {
          alert("è«‹è¼¸å…¥æª”æ¡ˆåç¨±");
          return;
        }

        // æª¢æŸ¥æª”æ¡ˆå¤§å°
        if (videoFile.size > 100 * 1024 * 1024) {
          alert("æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 100MBï¼Œè«‹ä¿®å‰ªå½±ç‰‡é•·åº¦");
          return;
        }

        formData.append("video", videoFile);
        formData.append("custom_filename", customFilename);

        // é—œé–‰ä¸Šå‚³è¡¨å–®
        closeUploadForm();

        // é¡¯ç¤ºä¸Šå‚³ä¸­çš„æç¤º
        showUploadProgress(`
            <div style="font-size: 16px; margin: 10px 0;">å½±ç‰‡ä¸Šå‚³ä¸­...</div>
            <small style="color: #999">è«‹å‹¿é—œé–‰è¦–çª—ï¼Œä¸Šå‚³å®Œæˆå¾Œæœƒè‡ªå‹•è™•ç†</small>
        `);

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (data.success) {
            showUploadProgress(`
                <div style="font-size: 16px; margin: 10px 0;">å½±ç‰‡è™•ç†ä¸­...</div>
                <small style="color: #999">æ­£åœ¨å£“ç¸®å½±ç‰‡ï¼Œè«‹ç¨å€™</small>
            `);

            // ä½¿ç”¨è¿”å›çš„æª”æ¡ˆåç¨±é€²è¡Œç‹€æ…‹æª¢æŸ¥
            const filename = data.filename;
            console.log("ä¸Šå‚³æˆåŠŸï¼Œæª”æ¡ˆåç¨±:", filename);

            while (true) {
              const status = await checkCompressionStatus(filename);
              console.log("ç•¶å‰ç‹€æ…‹:", status);

              if (status === "completed") {
                showUploadProgress(`
                        <div style="color: #2ecc71; font-size: 40px; margin: 10px 0;">âœ“</div>
                        <div style="font-size: 16px;">è™•ç†å®Œæˆï¼</div>
                        <small style="color: #999">é é¢å³å°‡é‡æ–°æ•´ç†</small>
                    `);

                setTimeout(() => {
                  hideUploadProgress();
                  location.reload();
                }, 1500);
                break;
              } else if (status === "error") {
                showUploadProgress(`
                        <div style="color: #e74c3c; font-size: 40px; margin: 10px 0;">âœ—</div>
                        <div style="font-size: 16px;">å½±ç‰‡è™•ç†å¤±æ•—</div>
                    `);
                throw new Error("å£“ç¸®å¤±æ•—");
              } else if (status === "compressing") {
                await new Promise((resolve) => setTimeout(resolve, 1000));
              } else {
                console.error("æœªçŸ¥çš„å£“ç¸®ç‹€æ…‹:", status);
                throw new Error("æœªçŸ¥çš„è™•ç†ç‹€æ…‹");
              }
            }
          } else {
            throw new Error(data.error || "ä¸Šå‚³å¤±æ•—");
          }
        } catch (error) {
          console.error("Error:", error);
          showUploadProgress(`
              <div style="color: #e74c3c; font-size: 40px; margin: 10px 0;">âœ—</div>
              <div style="font-size: 16px;">${
                error.message || "è™•ç†éç¨‹ç™¼ç”ŸéŒ¯èª¤"
              }</div>
          `);
          setTimeout(() => {
            hideUploadProgress();
          }, 1500);
        }
      };
		
async function updateRankings() {
    try {
        const response = await fetch("/rankings");
        const rankings = await response.json();

        const rankingsList = document.querySelector(".rankings-list");
        rankingsList.innerHTML = ""; // æ¸…ç©ºèˆŠçš„æ’è¡Œæ¦œå…§å®¹

        // é‡æ–°ç”Ÿæˆæ’è¡Œæ¦œé …ç›®
        rankings.forEach((video, index) => {
            const rankingItem = document.createElement("div");
            rankingItem.className = "ranking-item";

            rankingItem.innerHTML = `
                <span class="ranking-position">${index + 1}</span>
                <img class="ranking-thumbnail" src="/thumbnails/${video.filename}.jpg" alt="${video.title}">
                <span class="ranking-title">${video.title}</span>
                <span class="ranking-votes">${video.votes} ç¥¨</span>
            `;

            rankingsList.appendChild(rankingItem);
        });
    } catch (error) {
        console.error("æ›´æ–°æ’è¡Œæ¦œå¤±æ•—:", error);
    }
}

      // æ¯ 5 ç§’æ›´æ–°ä¸€æ¬¡æ’è¡Œæ¦œ
      setInterval(updateRankings, 10000);
      // åˆå§‹åŒ–æ’è¡Œæ¦œ
      updateRankings();

      // æ·»åŠ æ’è¡Œæ¦œåˆ‡æ›åŠŸèƒ½
      document
        .querySelector(".rankings-toggle")
        .addEventListener("click", () => {
          document
            .querySelector(".rankings-container")
            .classList.toggle("collapsed");
        });

      // ä¿®æ”¹ç”Ÿæˆç€è¦½å™¨æŒ‡ç´‹çš„å‡½æ•¸
      function generateFingerprint() {
        const components = {
          userAgent: navigator.userAgent,
          language: navigator.language,
          platform: navigator.platform,
          screenResolution: `${screen.width}x${screen.height}`,
          colorDepth: screen.colorDepth,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          touchSupport: "ontouchstart" in window,
          cookiesEnabled: navigator.cookieEnabled,
          // æ·»åŠ æ›´å¤šå¯é çš„ç‰¹å¾µ
          pixelRatio: window.devicePixelRatio,
          orientation: screen.orientation ? screen.orientation.type : "unknown",
          plugins: Array.from(navigator.plugins)
            .map((p) => p.name)
            .join(","),
          doNotTrack: navigator.doNotTrack,
          webdriver: navigator.webdriver,
          languages: navigator.languages.join(","),
        };

        // ä½¿ç”¨ç°¡å–®çš„å­—ä¸²è™•ç†ä¾†ç”ŸæˆæŒ‡ç´‹
        const fingerprintStr = JSON.stringify(components);
        let hash = 0;

        for (let i = 0; i < fingerprintStr.length; i++) {
          const char = fingerprintStr.charCodeAt(i);
          hash = (hash << 5) - hash + char;
          hash = hash & hash; // Convert to 32-bit integer
        }

        // è½‰æ›ç‚ºæ­£æ•¸ä¸¦è½‰ç‚º 16 é€²åˆ¶
        const positiveHash = Math.abs(hash).toString(16);
        // è£œè¶³ 32 ä½
        return "0".repeat(32 - positiveHash.length) + positiveHash;
      }

      // æ·»åŠ æ›´æ–°æŠ•ç¥¨æŒ‰éˆ•çš„å‡½æ•¸
      function updateVoteButton(button, voted, votes) {
        if (voted) {
          button.classList.add("voted");
        } else {
          button.classList.remove("voted");
        }
        button.innerHTML = `æŠ•ç¥¨ <span class="vote-count">${votes}</span>`;
      }
    </script>
  </body>
</html>
